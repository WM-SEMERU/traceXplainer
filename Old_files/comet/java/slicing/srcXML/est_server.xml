<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<unit xmlns="http://www.srcML.org/srcML/src" xmlns:cpp="http://www.srcML.org/srcML/cpp" revision="0.9.5" language="C" filename="est_server.c"><comment type="block">/** @file */</comment>
<comment type="block">/*------------------------------------------------------------------
 * est/est_server.c - EST Server specific code
 *
 *	       Assumptions:  - Web server using this module utilizes
 *	                       OpenSSL for HTTPS services.
 *	                     - OpenSSL is linked along with this
 *	                       modulue.
 *
 * April, 2013
 *
 * Copyright (c) 2013-2014, 2016 by cisco Systems, Inc.
 * All rights reserved.
 **------------------------------------------------------------------
 */</comment>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>&lt;string.h&gt;</cpp:file></cpp:include>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>&lt;stdlib.h&gt;</cpp:file></cpp:include>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>&lt;stdint.h&gt;</cpp:file></cpp:include>
<cpp:ifdef>#<cpp:directive>ifdef</cpp:directive> <name>WIN32</name></cpp:ifdef>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>&lt;WS2tcpip.h&gt;</cpp:file></cpp:include>
<cpp:endif>#<cpp:directive>endif</cpp:directive></cpp:endif>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>"est.h"</cpp:file></cpp:include>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>"est_server_http.h"</cpp:file></cpp:include>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>"est_locl.h"</cpp:file></cpp:include>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>"est_ossl_util.h"</cpp:file></cpp:include>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>"safe_mem_lib.h"</cpp:file></cpp:include>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>"safe_str_lib.h"</cpp:file></cpp:include>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>&lt;openssl/x509.h&gt;</cpp:file></cpp:include>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>&lt;openssl/x509v3.h&gt;</cpp:file></cpp:include>

<decl_stmt><decl><specifier>static</specifier> <type><name>ASN1_OBJECT</name> <modifier>*</modifier></type><name>o_cmcRA</name> <init>= <expr><name>NULL</name></expr></init></decl>;</decl_stmt>

<comment type="block">/*
 * This function sends EST specific HTTP error responses.
 */</comment>
<function><type><name>void</name></type> <name>est_send_http_error</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>void</name> <modifier>*</modifier></type><name>http_ctx</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>fail_code</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name><name>struct</name> <name>mg_connection</name></name> <modifier>*</modifier></type><name>conn</name> <init>= <expr><operator>(</operator>struct <name>mg_connection</name><operator>*</operator><operator>)</operator><name>http_ctx</name></expr></init></decl>;</decl_stmt>

    <switch>switch <condition>(<expr><name>fail_code</name></expr>)</condition> <block>{
    <case>case <expr><name>EST_ERR_BAD_PKCS10</name></expr>:</case>
	<expr_stmt><expr><call><name>mg_send_http_error</name><argument_list>(<argument><expr><name>conn</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_400</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_400_TXT</name></expr></argument>, <argument><expr><name>EST_BODY_BAD_PKCS10</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break>break;</break>
    <case>case <expr><name>EST_ERR_AUTH_FAIL</name></expr>:</case>
	<expr_stmt><expr><call><name>mg_send_http_error</name><argument_list>(<argument><expr><name>conn</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_401</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_401_TXT</name></expr></argument>, <argument><expr><name>EST_BODY_UNAUTHORIZED</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break>break;</break>
    <case>case <expr><name>EST_ERR_WRONG_METHOD</name></expr>:</case>
	<expr_stmt><expr><call><name>mg_send_http_error</name><argument_list>(<argument><expr><name>conn</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_400</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_400_TXT</name></expr></argument>, <argument><expr><name>EST_BODY_BAD_METH</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break>break;</break>
    <case>case <expr><name>EST_ERR_NO_SSL_CTX</name></expr>:</case>
	<expr_stmt><expr><call><name>mg_send_http_error</name><argument_list>(<argument><expr><name>conn</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_400</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_400_TXT</name></expr></argument>, <argument><expr><name>EST_BODY_BAD_SSL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break>break;</break>
    <case>case <expr><name>EST_ERR_HTTP_NOT_FOUND</name></expr>:</case>
	<expr_stmt><expr><call><name>mg_send_http_error</name><argument_list>(<argument><expr><name>conn</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_404</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_404_TXT</name></expr></argument>, <argument><expr><name>EST_BODY_NOT_FOUND</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break>break;</break>
    <case>case <expr><name>EST_ERR_HTTP_NO_CONTENT</name></expr>:</case>
	<expr_stmt><expr><call><name>mg_send_http_error</name><argument_list>(<argument><expr><name>conn</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_204</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_204_TXT</name></expr></argument>, <argument><expr><literal type="string">""</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break>break;</break>
    <default>default:</default>
	<expr_stmt><expr><call><name>mg_send_http_error</name><argument_list>(<argument><expr><name>conn</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_400</name></expr></argument>, <argument><expr><name>EST_HTTP_STAT_400_TXT</name></expr></argument>, <argument><expr><name>EST_BODY_UNKNOWN_ERR</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break>break;</break>
    }</block></switch>
}</block></function>

<comment type="block">/*
 * This function sends a HTTP 202 Accepted response to the 
 * client with the retry-after value from the CA. This
 * notifies the client that it should check back later to
 * see if the CSR was approved.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_send_http_retry_after</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>void</name> <modifier>*</modifier></type><name>http_ctx</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>delay</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>char</name></type> <name><name>http_hdr</name><index>[<expr><name>EST_HTTP_HDR_MAX</name></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name><name>struct</name> <name>mg_connection</name></name> <modifier>*</modifier></type><name>conn</name> <init>= <expr><operator>(</operator>struct <name>mg_connection</name><operator>*</operator><operator>)</operator><name>http_ctx</name></expr></init></decl>;</decl_stmt>

    <expr_stmt><expr><call><name>snprintf</name><argument_list>(<argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>, <argument><expr><literal type="string">"%s%s%s%s%s: %d%s%s"</literal></expr></argument>, 
	<argument><expr><name>EST_HTTP_HDR_202</name></expr></argument>,
        <argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>, 
	<argument><expr><name>EST_HTTP_HDR_STAT_202</name></expr></argument>, 
	<argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>,
	<argument><expr><name>EST_HTTP_HDR_RETRY_AFTER</name></expr></argument>, 
	<argument><expr><name>delay</name></expr></argument>, 
	<argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>, 
	<argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <expr_stmt><expr><name><name>conn</name><operator>-&gt;</operator><name>status_code</name></name> <operator>=</operator> <name>EST_HTTP_STAT_202</name></expr>;</expr_stmt>
    <if>if <condition>(<expr><operator>!</operator><call><name>mg_write</name><argument_list>(<argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><call><name>strnlen_s</name><argument_list>(<argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"HTTP write error while propagating retry-after"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_HTTP_WRITE</name><operator>)</operator></expr>;</return>
    }</block></then></if>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*
 * This function handles an incoming cacerts request from
 * the client.
 */</comment>
<function><type><name>int</name></type> <name>est_handle_cacerts</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>unsigned</name> <name>char</name> <modifier>*</modifier></type><name>ca_certs</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>ca_certs_len</name></decl></parameter>,
                        <parameter><decl><type><name>void</name> <modifier>*</modifier></type><name>http_ctx</name></decl></parameter>, <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>path_seg</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>char</name></type> <name><name>http_hdr</name><index>[<expr><name>EST_HTTP_HDR_MAX</name></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>hdrlen</name></decl>;</decl_stmt>    
    
    <if>if <condition>(<expr><name>ca_certs</name>  <operator>==</operator> <name>NULL</name></expr>)</condition><then> <block>{
        <return>return <expr><operator>(</operator><name>EST_ERR_HTTP_NOT_FOUND</name><operator>)</operator></expr>;</return>
    }</block></then></if>
        
    <comment type="block">/*
     * Send HTTP header
     */</comment>
    <expr_stmt><expr><call><name>snprintf</name><argument_list>(<argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>, <argument><expr><literal type="string">"%s%s%s%s"</literal></expr></argument>, <argument><expr><name>EST_HTTP_HDR_200</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>,
             <argument><expr><name>EST_HTTP_HDR_STAT_200</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><name>hdrlen</name> <operator>=</operator> <call><name>strnlen_s</name><argument_list>(<argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>snprintf</name><argument_list>(<argument><expr><name>http_hdr</name> <operator>+</operator> <name>hdrlen</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>, <argument><expr><literal type="string">"%s: %s%s"</literal></expr></argument>, <argument><expr><name>EST_HTTP_HDR_CT</name></expr></argument>,
             <argument><expr><name>EST_HTTP_CT_PKCS7</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><name>hdrlen</name> <operator>=</operator> <call><name>strnlen_s</name><argument_list>(<argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>snprintf</name><argument_list>(<argument><expr><name>http_hdr</name> <operator>+</operator> <name>hdrlen</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>, <argument><expr><literal type="string">"%s: %s%s"</literal></expr></argument>, <argument><expr><name>EST_HTTP_HDR_CE</name></expr></argument>,
             <argument><expr><name>EST_HTTP_CE_BASE64</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><name>hdrlen</name> <operator>=</operator> <call><name>strnlen_s</name><argument_list>(<argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>snprintf</name><argument_list>(<argument><expr><name>http_hdr</name> <operator>+</operator> <name>hdrlen</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>, <argument><expr><literal type="string">"%s: %d%s%s"</literal></expr></argument>, <argument><expr><name>EST_HTTP_HDR_CL</name></expr></argument>,
             <argument><expr><name>ca_certs_len</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><operator>!</operator><call><name>mg_write</name><argument_list>(<argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><call><name>strnlen_s</name><argument_list>(<argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
        <return>return <expr><operator>(</operator><name>EST_ERR_HTTP_WRITE</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Send the CA certs in the body
     */</comment>
    <if>if <condition>(<expr><operator>!</operator><call><name>mg_write</name><argument_list>(<argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>ca_certs</name></expr></argument>, <argument><expr><name>ca_certs_len</name></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
        <return>return <expr><operator>(</operator><name>EST_ERR_HTTP_WRITE</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"CA certs successfully sent to EST client"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>


<comment type="block">/*
 * Handle a CA certs request.  If the application layer has
 * registered a callback then call it.  Else, if the application
 * layer has provided a locally configured buffer then send it.
 * Else, return an error indicating that there are no CA Certs
 * available.
 */</comment>
<function><specifier>static</specifier> <type><name>int</name></type> <name>est_server_handle_cacerts</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>void</name> <modifier>*</modifier></type><name>http_ctx</name></decl></parameter>,
                                      <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>path_seg</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>EST_ERROR</name></type> <name>rv</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>ca_certs_len</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>unsigned</name> <name>char</name> <modifier>*</modifier></type><name>ca_certs</name></decl>;</decl_stmt>

    <comment type="block">/*
     * If there is a call back set then call it.
     * otherwise, if there is a locally configured cacerts buffer,
     * then return that.
     * otherwise, return an error indicating that we don't have any cacerts
     */</comment>
    <if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>est_get_cacerts_cb</name></name></expr>)</condition><then> <block>{

        <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"Server: Retrieving CA certs from application layer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><name>ca_certs</name> <operator>=</operator> <call><name><name>ctx</name><operator>-&gt;</operator><name>est_get_cacerts_cb</name></name><argument_list>(<argument><expr><operator>&amp;</operator><name>ca_certs_len</name></expr></argument>, <argument><expr><name>path_seg</name></expr></argument>,<argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>ex_data</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if>if <condition>(<expr><name>ca_certs</name></expr>)</condition><then> <block>{

            <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"Server: Successfully retrieved CA certs from "</literal>
                         <literal type="string">"application layer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name>est_handle_cacerts</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>ca_certs</name></expr></argument>, <argument><expr><name>ca_certs_len</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>,
                                    <argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        }</block></then> <else>else <block>{
            <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_HTTP_NO_CONTENT</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>rv</name> <operator>=</operator> <name>EST_ERR_NONE</name></expr>;</expr_stmt>
        }</block></else></if>
    }</block></then> <elseif>else <if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>ca_certs</name></name></expr>)</condition><then> <block>{
        
        <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"Server: CA certs set locally, responding with "</literal>
                     <literal type="string">"locally set CA certs response"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name>est_handle_cacerts</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>ca_certs</name></name></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>ca_certs_len</name></name></expr></argument>,
                                      <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></then></if></elseif> <else>else <block>{
        
        <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_HTTP_NO_CONTENT</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><name>rv</name> <operator>=</operator> <name>EST_ERR_NONE</name></expr>;</expr_stmt>
    }</block></else></if>
    <return>return <expr><operator>(</operator><name>rv</name><operator>)</operator></expr>;</return>
}</block></function>


<comment type="block">/*! @brief est_server_generate_auth_digest() is used by an application 
    to calculate the HTTP Digest value based on the header values
    provided by an EST client.  
 
    @param ah Authentication header values from client, provided by libEST
    @param HA1 The precalculated HA1 value for the user.  HA1 is defined in
           RFC 2617.  It's the MD5 calculation of the user's ID, HTTP realm,
	   and the user's password.

    This is a helper function that an application can use to calculate
    the HTTP Digest value when performing HTTP Digest Authentication
    of an EST client.  libEST does not maintain a user database. 
    This is left up to the application, with the intent of integrating  
    an external user database (e.g. Radius/AAA).
    
    The HA1 value should be calculated by the application as
    defined in RFC 2617.  HA1 is the MD5 hash of the user ID, HTTP realm,
    and user password.  This MD5 value is then converted to a hex string.
    HA1 is expected to be 32 bytes long.
 
    @return char* containing the digest, or NULL if an error occurred.
 */</comment>
<function><type><name>char</name> <modifier>*</modifier></type><name>est_server_generate_auth_digest</name> <parameter_list>(<parameter><decl><type><name>EST_HTTP_AUTH_HDR</name> <modifier>*</modifier></type><name>ah</name></decl></parameter>, <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>HA1</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>EVP_MD_CTX</name> <modifier>*</modifier></type><name>mdctx</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><specifier>const</specifier> <name>EVP_MD</name> <modifier>*</modifier></type><name>md</name> <init>= <expr><call><name>EVP_md5</name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>uint8_t</name></type> <name><name>ha2</name><index>[<expr><name>EVP_MAX_MD_SIZE</name></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>unsigned</name> <name>int</name></type> <name>ha2_len</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>char</name></type> <name><name>ha2_str</name><index>[<expr><literal type="number">33</literal></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>unsigned</name> <name>char</name></type> <name><name>digest</name><index>[<expr><name>EVP_MAX_MD_SIZE</name></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>unsigned</name> <name>int</name></type> <name>d_len</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>char</name> <modifier>*</modifier></type><name>rv</name></decl>;</decl_stmt>

    <if>if <condition>(<expr><operator>!</operator><name>ah</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null auth header"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>NULL</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <if>if <condition>(<expr><operator>!</operator><name>HA1</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null HA1"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>NULL</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Calculate HA2 using method, URI,
     */</comment>
    <expr_stmt><expr><name>mdctx</name> <operator>=</operator> <call><name>EVP_MD_CTX_create</name><argument_list>()</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestInit_ex</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><name>md</name></expr></argument>, <argument><expr><name>NULL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><literal type="string">"POST"</literal></expr></argument>, <argument><expr><literal type="number">4</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt> 
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><literal type="string">":"</literal></expr></argument>, <argument><expr><literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><name><name>ah</name><operator>-&gt;</operator><name>uri</name></name></expr></argument>, <argument><expr><call><name>strnlen_s</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>uri</name></name></expr></argument>, <argument><expr><name>MAX_REALM</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestFinal</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><name>ha2</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>ha2_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_MD_CTX_destroy</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>est_hex_to_str</name><argument_list>(<argument><expr><name>ha2_str</name></expr></argument>, <argument><expr><name>ha2</name></expr></argument>, <argument><expr><name>ha2_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block">/*
     * Calculate auth digest using HA1, nonce, nonce count, client nonce, qop, HA2
     */</comment>
    <expr_stmt><expr><name>mdctx</name> <operator>=</operator> <call><name>EVP_MD_CTX_create</name><argument_list>()</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestInit_ex</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><name>md</name></expr></argument>, <argument><expr><name>NULL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><name>HA1</name></expr></argument>, <argument><expr><literal type="number">32</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt> 
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><literal type="string">":"</literal></expr></argument>, <argument><expr><literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><name><name>ah</name><operator>-&gt;</operator><name>nonce</name></name></expr></argument>, <argument><expr><call><name>strnlen_s</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>nonce</name></name></expr></argument>, <argument><expr><name>MAX_NONCE</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><literal type="string">":"</literal></expr></argument>, <argument><expr><literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><name><name>ah</name><operator>-&gt;</operator><name>nc</name></name></expr></argument>, <argument><expr><call><name>strnlen_s</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>nc</name></name></expr></argument>, <argument><expr><name>MAX_NC</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><literal type="string">":"</literal></expr></argument>, <argument><expr><literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><name><name>ah</name><operator>-&gt;</operator><name>cnonce</name></name></expr></argument>, <argument><expr><call><name>strnlen_s</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>cnonce</name></name></expr></argument>, <argument><expr><name>MAX_NONCE</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><literal type="string">":"</literal></expr></argument>, <argument><expr><literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><literal type="string">"auth"</literal></expr></argument>, <argument><expr><literal type="number">4</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><literal type="string">":"</literal></expr></argument>, <argument><expr><literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestUpdate</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><name>ha2_str</name></expr></argument>, <argument><expr><name>ha2_len</name> <operator>*</operator> <literal type="number">2</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_DigestFinal</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>, <argument><expr><name>digest</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>d_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_MD_CTX_destroy</name><argument_list>(<argument><expr><name>mdctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name>malloc</name><argument_list>(<argument><expr><literal type="number">33</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>est_hex_to_str</name><argument_list>(<argument><expr><name>rv</name></expr></argument>, <argument><expr><name>digest</name></expr></argument>, <argument><expr><name>d_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>rv</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*
 * This function allocates an HTTP authentication header
 * structure, which is used to pass the auth credentials
 * to the application layer to allow the app to authenticate
 * an EST client.
 */</comment>
<function><specifier>static</specifier> <type><name>EST_HTTP_AUTH_HDR</name> <modifier>*</modifier></type> <name>est_create_ah</name><parameter_list>()</parameter_list>
<block>{
    <decl_stmt><decl><type><name>EST_HTTP_AUTH_HDR</name> <modifier>*</modifier></type><name>ah</name></decl>;</decl_stmt>

    <expr_stmt><expr><name>ah</name> <operator>=</operator> <call><name>malloc</name><argument_list>(<argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name>EST_HTTP_AUTH_HDR</name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>memzero_s</name><argument_list>(<argument><expr><name>ah</name></expr></argument>, <argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name>EST_HTTP_AUTH_HDR</name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>ah</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*
 * This function frees all the elements on an HTTP
 * authentication header structure.
 */</comment>
<function><specifier>static</specifier> <type><name>void</name></type> <name>est_destroy_ah</name><parameter_list>(<parameter><decl><type><name>EST_HTTP_AUTH_HDR</name> <modifier>*</modifier></type><name>ah</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>int</name></type> <name>len</name></decl>;</decl_stmt>

    <if>if <condition>(<expr><operator>!</operator><name>ah</name></expr>)</condition><then> <block type="pseudo"><return>return;</return></block></then></if>
    <if>if <condition>(<expr><name><name>ah</name><operator>-&gt;</operator><name>user</name></name></expr>)</condition><then> <block type="pseudo"><expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>user</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block></then></if>
    <if>if <condition>(<expr><name><name>ah</name><operator>-&gt;</operator><name>pwd</name></name></expr>)</condition><then> <block>{
	<comment type="block">/*
	 * Get the length of the password so it can be zeroized 
	 */</comment>
	<expr_stmt><expr><name>len</name> <operator>=</operator> <call><name>strnlen_s</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>pwd</name></name></expr></argument>, <argument><expr><name>MAX_UIDPWD</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><name>len</name></expr>)</condition><then> <block>{
	    <expr_stmt><expr><call><name>memzero_s</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>pwd</name></name></expr></argument>, <argument><expr><name>len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	}</block></then></if>
	<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>pwd</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></then></if>
    <if>if <condition>(<expr><name><name>ah</name><operator>-&gt;</operator><name>uri</name></name></expr>)</condition><then> <block type="pseudo"><expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>uri</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block></then></if>
    <if>if <condition>(<expr><name><name>ah</name><operator>-&gt;</operator><name>cnonce</name></name></expr>)</condition><then> <block type="pseudo"><expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>cnonce</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block></then></if>
    <if>if <condition>(<expr><name><name>ah</name><operator>-&gt;</operator><name>qop</name></name></expr>)</condition><then> <block type="pseudo"><expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>qop</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block></then></if>
    <if>if <condition>(<expr><name><name>ah</name><operator>-&gt;</operator><name>nc</name></name></expr>)</condition><then> <block type="pseudo"><expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>nc</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block></then></if>
    <if>if <condition>(<expr><name><name>ah</name><operator>-&gt;</operator><name>nonce</name></name></expr>)</condition><then> <block type="pseudo"><expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>nonce</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block></then></if>
    <if>if <condition>(<expr><name><name>ah</name><operator>-&gt;</operator><name>response</name></name></expr>)</condition><then> <block type="pseudo"><expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>response</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block></then></if>
    <if>if <condition>(<expr><name><name>ah</name><operator>-&gt;</operator><name>auth_token</name></name></expr>)</condition><then> <block>{
	<expr_stmt><expr><name>len</name> <operator>=</operator> <call><name>strnlen_s</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>auth_token</name></name></expr></argument>, <argument><expr><name>MAX_AUTH_TOKEN_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><name>len</name></expr>)</condition><then> <block>{
	    <expr_stmt><expr><call><name>memzero_s</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>auth_token</name></name></expr></argument>, <argument><expr><name>len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	}</block></then></if>
	<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name><name>ah</name><operator>-&gt;</operator><name>auth_token</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></then></if>
    <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>ah</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
}</block></function>

<comment type="block">/*
 * This function verifies that the peer either provided a certificate
 * that was verifed by the TLS stack, or HTTP authentication
 * credentials were provided. 
 *
 * Returns a EST_AUTH_STATE authorization result 
 */</comment>
<function><type><name>EST_AUTH_STATE</name></type> <name>est_enroll_auth</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>void</name> <modifier>*</modifier></type><name>http_ctx</name></decl></parameter>, <parameter><decl><type><name>SSL</name> <modifier>*</modifier></type><name>ssl</name></decl></parameter>,
	                        <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>path_seg</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>reenroll</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>EST_AUTH_STATE</name></type> <name>rv</name> <init>= <expr><name>EST_UNAUTHORIZED</name></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>X509</name> <modifier>*</modifier></type><name>peer</name> <init>= <expr><name>NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name><name>struct</name> <name>mg_connection</name></name> <modifier>*</modifier></type><name>conn</name> <init>= <expr><operator>(</operator>struct <name>mg_connection</name><operator>*</operator><operator>)</operator><name>http_ctx</name></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>EST_HTTP_AUTH_HDR</name> <modifier>*</modifier></type><name>ah</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>EST_HTTP_AUTH_HDR_RESULT</name></type> <name>pr</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>v_result</name></decl>;</decl_stmt>

    <comment type="block">/*
     * Get client certificate from TLS stack.  
     */</comment>
    <if>if <condition>(<expr><operator>(</operator><name>peer</name> <operator>=</operator> <call><name>SSL_get_peer_certificate</name><argument_list>(<argument><expr><name>ssl</name></expr></argument>)</argument_list></call><operator>)</operator> <operator>!=</operator> <name>NULL</name></expr>)</condition><then> <block>{
        <comment type="line">// check TLS based client authorization (is client cert authorized)</comment>
        <expr_stmt><expr><name>v_result</name> <operator>=</operator> <operator>(</operator><name>int</name><operator>)</operator> <call><name>SSL_get_verify_result</name><argument_list>(<argument><expr><name>ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if>if <condition>(<expr><name>X509_V_OK</name> <operator>==</operator> <name>v_result</name></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"TLS: client certificate is valid"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><name>rv</name> <operator>=</operator> <name>EST_CERT_AUTH</name></expr>;</expr_stmt>
	}</block></then>
	<elseif>else <if>if <condition>(<expr><name>X509_V_ERR_UNABLE_TO_GET_CRL</name> <operator>==</operator> <name>v_result</name></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"Peer cert is valid, but no CRL was loaded. Unable to determine if peer cert is revoked."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><name>rv</name> <operator>=</operator> <name>EST_CERT_AUTH</name></expr>;</expr_stmt>
        }</block></then></if></elseif> <else>else <block>{
            <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"TLS: client certificate not verified (v_result=%d)"</literal></expr></argument>,
		         <argument><expr><name>v_result</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <comment type="block">/* We need to bail since the client is using a bogus cert,
	     * no need to contiue with HTTP authentication below */</comment>
	    <expr_stmt><expr><call><name>X509_free</name><argument_list>(<argument><expr><name>peer</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <return>return<expr><operator>(</operator><name>EST_UNAUTHORIZED</name><operator>)</operator></expr>;</return>
        }</block></else></if>
    }</block></then> <else>else <block>{
        <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"TLS: no peer certificate"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><name>rv</name> <operator>=</operator> <name>EST_UNAUTHORIZED</name></expr>;</expr_stmt>
    }</block></else></if>

    <comment type="block">/*
     * See if SRP is being used.  If so, there will be no
     * certificate.
     */</comment>
    <if>if <condition>(<expr><name>rv</name> <operator>!=</operator> <name>EST_CERT_AUTH</name> <operator>&amp;&amp;</operator> <call><name>SSL_get_srp_username</name><argument_list>(<argument><expr><name>ssl</name></expr></argument>)</argument_list></call> <operator>!=</operator> <name>NULL</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"TLS: no certificate from client, SRP login is %s"</literal></expr></argument>,
		<argument><expr><call><name>SSL_get_srp_username</name><argument_list>(<argument><expr><name>ssl</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><name>rv</name> <operator>=</operator> <name>EST_SRP_AUTH</name></expr>;</expr_stmt>
    }</block></then></if>

    <comment type="block">/*
     * If the application layer has enabled HTTP authentication we
     * will attempt HTTP authentication when TLS client auth fails
     * or when the require_http_auth flag is set by the application.
     * All this assumes the application layer has provided the HTTP auth
     * callback facility.
     */</comment>
    <if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>est_http_auth_cb</name></name> <operator>&amp;&amp;</operator> 
	<operator>(</operator><name>rv</name> <operator>==</operator> <name>EST_UNAUTHORIZED</name> <operator>||</operator> <name>HTTP_AUTH_REQUIRED</name> <operator>==</operator> <name><name>ctx</name><operator>-&gt;</operator><name>require_http_auth</name></name><operator>)</operator></expr>)</condition><then> <block>{
        <comment type="block">/*
         * Try HTTP authentication.
         */</comment>
	<expr_stmt><expr><name>ah</name> <operator>=</operator> <call><name>est_create_ah</name><argument_list>()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><name>pr</name> <operator>=</operator> <call><name>mg_parse_auth_header</name><argument_list>(<argument><expr><name>conn</name></expr></argument>, <argument><expr><name>ah</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<switch>switch <condition>(<expr><name>pr</name></expr>)</condition> <block>{
        <case>case <expr><name>EST_AUTH_HDR_GOOD</name></expr>:</case>
	    <comment type="block">/*
	     * Invoke the application specific auth check now 
	     * that we have the user's credentials
	     */</comment>
	    <if>if <condition>(<expr><call><name><name>ctx</name><operator>-&gt;</operator><name>est_http_auth_cb</name></name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>ah</name></expr></argument>, <argument><expr><name>peer</name></expr></argument>, <argument><expr><name>path_seg</name></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>ex_data</name></name></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
		<expr_stmt><expr><name>rv</name> <operator>=</operator> <name>EST_HTTP_AUTH</name></expr>;</expr_stmt>
	    }</block></then> <else>else <block>{
                <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"HTTP authentication failed. Auth type=%d"</literal></expr></argument>, 
                             <argument><expr><name><name>ah</name><operator>-&gt;</operator><name>mode</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<expr_stmt><expr><name>rv</name> <operator>=</operator> <name>EST_UNAUTHORIZED</name></expr>;</expr_stmt>
	    }</block></else></if>
	    <break>break;</break>
        <case>case <expr><name>EST_AUTH_HDR_MISSING</name></expr>:</case>
            <comment type="line">// ask client to send us authorization headers</comment>
            <expr_stmt><expr><call><name>mg_send_authorization_request</name><argument_list>(<argument><expr><name>conn</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"HTTP auth headers missing, sending HTTP auth request to client."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>rv</name> <operator>=</operator> <name>EST_HTTP_AUTH_PENDING</name></expr>;</expr_stmt>
	    <break>break;</break>
        <case>case <expr><name>EST_AUTH_HDR_BAD</name></expr>:</case>
	<default>default:</default>
            <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"Client sent incomplete HTTP authorization header"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt> 
	    <if>if <condition>(<expr><name>reenroll</name> <operator>&amp;&amp;</operator> <name>rv</name> <operator>==</operator> <name>EST_CERT_AUTH</name></expr>)</condition><then> <block>{
		<expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"Client cert was authenticated, HTTP auth not required for reenroll"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt> 
	    }</block></then> <else>else <block>{
		<expr_stmt><expr><name>rv</name> <operator>=</operator> <name>EST_UNAUTHORIZED</name></expr>;</expr_stmt>
	    }</block></else></if>
	    <break>break;</break>
	}</block></switch>
	<expr_stmt><expr><call><name>est_destroy_ah</name><argument_list>(<argument><expr><name>ah</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></then></if> 
    <if>if <condition>(<expr><name>peer</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>X509_free</name><argument_list>(<argument><expr><name>peer</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></then></if>
    <return>return <expr><operator>(</operator><name>rv</name><operator>)</operator></expr>;</return>

}</block></function>

<comment type="block">/*
 * This function is used to determine if the EST client, which could be
 * an RA, is using a certificate that contains the id-kp-cmcRA usage
 * extension.  When this usage bit is present, the PoP check is disabled
 * to allow the RA use case. 
 *
 * This logic was taken from x509v3_cache_extensions() in v3_purp.c (OpenSSL).
 *
 * Returns 1 if the cert contains id-kp-cmcRA extended key usage extension.
 * Otherwise it returns 0.
 */</comment>
<function><specifier>static</specifier> <type><name>int</name></type> <name>est_check_cmcRA</name> <parameter_list>(<parameter><decl><type><name>X509</name> <modifier>*</modifier></type><name>cert</name></decl></parameter>)</parameter_list> 
<block>{
    <decl_stmt><decl><type><name>int</name></type> <name>cmcRA_found</name> <init>= <expr><literal type="number">0</literal></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>EXTENDED_KEY_USAGE</name> <modifier>*</modifier></type><name>extusage</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>i</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>ASN1_OBJECT</name> <modifier>*</modifier></type><name>obj</name></decl>;</decl_stmt>

    <comment type="block">/*
     * Get the extended key usage extension.  If found
     * loop through the values and look for the ik-kp-cmcRA
     * value in this extension.
     */</comment>
    <if>if<condition>(<expr><operator>(</operator><name>extusage</name> <operator>=</operator> <call><name>X509_get_ext_d2i</name><argument_list>(<argument><expr><name>cert</name></expr></argument>, <argument><expr><name>NID_ext_key_usage</name></expr></argument>, <argument><expr><name>NULL</name></expr></argument>, <argument><expr><name>NULL</name></expr></argument>)</argument_list></call><operator>)</operator></expr>)</condition><then> <block>{
	<comment type="block">/*
	 * Iterate through the extended key usage values
	 */</comment>
        <for>for<control>(<init><expr><name>i</name> <operator>=</operator> <literal type="number">0</literal></expr>;</init> <condition><expr><name>i</name> <operator>&lt;</operator> <call><name>sk_ASN1_OBJECT_num</name><argument_list>(<argument><expr><name>extusage</name></expr></argument>)</argument_list></call></expr>;</condition> <incr><expr><name>i</name><operator>++</operator></expr></incr>)</control> <block>{
	    <expr_stmt><expr><name>obj</name> <operator>=</operator>  <call><name>sk_ASN1_OBJECT_value</name><argument_list>(<argument><expr><name>extusage</name></expr></argument>,<argument><expr><name>i</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <comment type="block">/*
	     * Compare the current iteration with the global
	     * id-kp-cmcRA value that was created earlier
	     */</comment>
            <if>if <condition>(<expr><operator>!</operator><call><name>OBJ_cmp</name><argument_list>(<argument><expr><name>obj</name></expr></argument>, <argument><expr><name>o_cmcRA</name></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
                <expr_stmt><expr><name>cmcRA_found</name> <operator>=</operator> <literal type="number">1</literal></expr>;</expr_stmt> 
                <break>break;</break>
            }</block></then></if>
        }</block></for>
        <expr_stmt><expr><call><name>sk_ASN1_OBJECT_pop_free</name><argument_list>(<argument><expr><name>extusage</name></expr></argument>, <argument><expr><name>ASN1_OBJECT_free</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></then></if>

    <return>return <expr><operator>(</operator><name>cmcRA_found</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*
 * This is a utility function to convert the base64 DER encoded
 * CSR to an OpenSSL X509_REQ pointer.  Returns NULL if there
 * was a problem.
 */</comment>
<function><type><name>X509_REQ</name> <modifier>*</modifier></type> <name>est_server_parse_csr</name> <parameter_list>(<parameter><decl><type><name>unsigned</name> <name>char</name> <modifier>*</modifier></type><name>pkcs10</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>pkcs10_len</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>BIO</name> <modifier>*</modifier></type><name>in</name></decl>, <modifier>*</modifier><decl><type ref="prev"/><name>b64</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>X509_REQ</name> <modifier>*</modifier></type><name>req</name></decl>;</decl_stmt>

    <comment type="block">/*
     * Get the original pkcs10 request from the client
     */</comment>
    <expr_stmt><expr><name>b64</name> <operator>=</operator> <call><name>BIO_new</name><argument_list>(<argument><expr><call><name>BIO_f_base64</name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><name>b64</name> <operator>==</operator> <name>NULL</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Unable to open PKCS10 b64 buffer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return>return <expr><operator>(</operator><name>NULL</name><operator>)</operator></expr>;</return>
    }</block></then></if>
    <expr_stmt><expr><name>in</name> <operator>=</operator> <call><name>BIO_new_mem_buf</name><argument_list>(<argument><expr><name>pkcs10</name></expr></argument>, <argument><expr><name>pkcs10_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><name>in</name> <operator>==</operator> <name>NULL</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Unable to open PKCS10 raw buffer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>BIO_free</name><argument_list>(<argument><expr><name>b64</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return>return <expr><operator>(</operator><name>NULL</name><operator>)</operator></expr>;</return>
    }</block></then></if>
    <expr_stmt><expr><name>in</name> <operator>=</operator> <call><name>BIO_push</name><argument_list>(<argument><expr><name>b64</name></expr></argument>, <argument><expr><name>in</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block">/*
     * Read the PEM encoded pkcs10 cert request
     */</comment>
    <if>if <condition>(<expr><operator>(</operator><name>req</name> <operator>=</operator> <call><name>d2i_X509_REQ_bio</name><argument_list>(<argument><expr><name>in</name></expr></argument>, <argument><expr><name>NULL</name></expr></argument>)</argument_list></call><operator>)</operator> <operator>==</operator> <name>NULL</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Problem reading DER encoded certificate request"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>ossl_dump_ssl_errors</name><argument_list>()</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>BIO_free_all</name><argument_list>(<argument><expr><name>in</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return>return <expr><operator>(</operator><name>NULL</name><operator>)</operator></expr>;</return>
    }</block></then></if>
    <expr_stmt><expr><call><name>BIO_free_all</name><argument_list>(<argument><expr><name>in</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <return>return <expr><name>req</name></expr>;</return>
}</block></function>

<comment type="block">/*
 * This function implements the Proof of Posession check (PoP).  The TLS UID has
 * already been saved from the TLS session earlier.  This TLS UID should match the
 * value of the challengePassword attribute in the pkcs10 client certificate.  The
 * client will have provided this value when signing the pkcs10 cert request
 * with its private key, which proves the client is in possession of the private key.
 * This check is enforced as follows:
 *     1. If CSR contains the PoP, it must be valid.
 *     2. If CSR didn't contain the PoP and the server is configured
 *        to require the PoP, then the authentication fails.
 *     3. Otherwise, if CSR didn't contain the PoP and the server is not
 *        configured to require PoP, then authentication passes.
 *
 * Parameters:
 *	ctx:	    Pointer to EST context
 *	ssl:        Pointer to SSL context
 *	pkcs10:	    Pointer to raw PKCS10 data
 *	pkcs10_len: Length of raw PKCS10 data
 *
 * Return value:
 *	EST_ERR_NONE when PoP check passes
 */</comment>
<function><type><name>int</name></type> <name>est_tls_uid_auth</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>SSL</name> <modifier>*</modifier></type><name>ssl</name></decl></parameter>, <parameter><decl><type><name>X509_REQ</name> <modifier>*</modifier></type><name>req</name></decl></parameter>)</parameter_list> 
<block>{
    <decl_stmt><decl><type><name>X509_ATTRIBUTE</name> <modifier>*</modifier></type><name>attr</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>i</name></decl>, <decl><type ref="prev"/><name>j</name></decl>;</decl_stmt>

    <decl_stmt><decl><type><name>ASN1_TYPE</name> <modifier>*</modifier></type><name>at</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>ASN1_BIT_STRING</name> <modifier>*</modifier></type><name>bs</name> <init>= <expr><name>NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>ASN1_TYPE</name> <modifier>*</modifier></type><name>t</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>rv</name> <init>= <expr><name>EST_ERR_NONE</name></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>char</name> <modifier>*</modifier></type><name>tls_uid</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>diff</name></decl>;</decl_stmt>

    <comment type="block">/*
     * Get the index of the challengePassword attribute in the request
     */</comment>
    <expr_stmt><expr><name>i</name> <operator>=</operator> <call><name>X509_REQ_get_attr_by_NID</name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>NID_pkcs9_challengePassword</name></expr></argument>, <argument><expr><operator>-</operator><literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><name>i</name> <operator>&lt;</operator> <literal type="number">0</literal></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"Cert request does not contain PoP challengePassword attribute"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<comment type="block">/*
	 * If PoP is enabled, we must fail at this point
	 * since the client didn't send the channel binding
	 * info in the CSR.
	 */</comment>
	<if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>server_enable_pop</name></name></expr>)</condition><then> <block>{
	    <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"PoP enabled, CSR was not authenticated"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>EST_ERR_AUTH_FAIL_TLSUID</name><operator>)</operator></expr>;</return>
	}</block></then> <else>else <block>{
	    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
	}</block></else></if>
    }</block></then> <else>else <block>{
        <comment type="block">/*
         * Get a reference to the attribute now that we know where it's located
	 * RFC 7030 requires that we check the PoP when it's present
         */</comment>
        <expr_stmt><expr><name>attr</name> <operator>=</operator> <call><name>X509_REQ_get_attr</name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>i</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

        <comment type="block">/*
         * If we found the attribute, get the actual value of the challengePassword
         */</comment>
        <if>if <condition>(<expr><name>attr</name></expr>)</condition><then> <block>{
            <if>if <condition>(<expr><name><name>attr</name><operator>-&gt;</operator><name>single</name></name></expr>)</condition><then> <block>{
                <expr_stmt><expr><name>t</name> <operator>=</operator> <name><name>attr</name><operator>-&gt;</operator><name>value</name><operator>.</operator><name>single</name></name></expr>;</expr_stmt>
                <expr_stmt><expr><name>bs</name> <operator>=</operator> <name><name>t</name><operator>-&gt;</operator><name>value</name><operator>.</operator><name>bit_string</name></name></expr>;</expr_stmt>
            }</block></then> <else>else <block>{
                <expr_stmt><expr><name>j</name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
                <expr_stmt><expr><name>at</name> <operator>=</operator> <call><name>sk_ASN1_TYPE_value</name><argument_list>(<argument><expr><name><name>attr</name><operator>-&gt;</operator><name>value</name><operator>.</operator><name>set</name></name></expr></argument>, <argument><expr><name>j</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt><expr><name>bs</name> <operator>=</operator> <name><name>at</name><operator>-&gt;</operator><name>value</name><operator>.</operator><name>asn1_string</name></name></expr>;</expr_stmt>
            }</block></else></if>
        }</block></then> <else>else <block>{
            <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"PoP challengePassword attribute not found in client cert request"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>EST_ERR_AUTH_FAIL_TLSUID</name><operator>)</operator></expr>;</return>
        }</block></else></if>

        <comment type="block">/*
         * Now that we have the challengePassword from the client cert request,
         * compare it to the TLS UID we calculated on the server side.
         * This implements the PoP check to verify the client holds the private
         * key used to sign the cert request.
         */</comment>
        <expr_stmt><expr><name>tls_uid</name> <operator>=</operator> <call><name>est_get_tls_uid</name><argument_list>(<argument><expr><name>ssl</name></expr></argument>, <argument><expr><literal type="number">0</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if>if <condition>(<expr><name>tls_uid</name></expr>)</condition><then> <block>{
	    <expr_stmt><expr><name>i</name> <operator>=</operator> <call><name>memcmp_s</name><argument_list>(<argument><expr><name>tls_uid</name></expr></argument>, <argument><expr><name>EST_TLS_UID_LEN</name></expr></argument>, <argument><expr><name><name>bs</name><operator>-&gt;</operator><name>data</name></name></expr></argument>, <argument><expr><name>EST_TLS_UID_LEN</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>diff</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <if>if <condition>(<expr><name>i</name> <operator>==</operator> <name>EOK</name> <operator>&amp;&amp;</operator> <operator>!</operator><name>diff</name></expr>)</condition><then> <block>{
                <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"PoP is valid"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt><expr><name>rv</name> <operator>=</operator> <name>EST_ERR_NONE</name></expr>;</expr_stmt>
            }</block></then> <else>else <block>{
                <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"PoP is not valid"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt><expr><name>rv</name> <operator>=</operator> <name>EST_ERR_AUTH_FAIL_TLSUID</name></expr>;</expr_stmt>
            }</block></else></if>
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>tls_uid</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        }</block></then> <else>else <block>{
            <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"Local TLS channel binding info is not available"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>rv</name> <operator>=</operator> <name>EST_ERR_AUTH_FAIL_TLSUID</name></expr>;</expr_stmt>
        }</block></else></if>
    }</block></else></if>

    <return>return <expr><name>rv</name></expr>;</return>
}</block></function>

<comment type="block">/*
 * This function performs a simple sanity check on a PKCS10
 * CSR.  It will check the signature in the CSR.
 * Returns 0 for success, non-zero if the sanity check failed.
 */</comment>
<function><type><name>int</name></type> <name>est_server_check_csr</name> <parameter_list>(<parameter><decl><type><name>X509_REQ</name> <modifier>*</modifier></type><name>req</name></decl></parameter>)</parameter_list> 
<block>{
    <decl_stmt><decl><type><name>EVP_PKEY</name> <modifier>*</modifier></type><name>pub_key</name> <init>= <expr><name>NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>rc</name></decl>;</decl_stmt>

    <comment type="block">/*
     * Extract the public key from the CSR
     */</comment>
    <if>if <condition>(<expr><operator>(</operator><name>pub_key</name> <operator>=</operator> <call><name>X509_REQ_get_pubkey</name><argument_list>(<argument><expr><name>req</name></expr></argument>)</argument_list></call><operator>)</operator> <operator>==</operator> <name>NULL</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Unable to extract public key from CSR"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return>return <expr><literal type="number">1</literal></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Verify the signature in the CSR 
     */</comment>
    <expr_stmt><expr><name>rc</name> <operator>=</operator> <call><name>X509_REQ_verify</name><argument_list>(<argument><expr><name>req</name></expr></argument>, <argument><expr><name>pub_key</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>EVP_PKEY_free</name><argument_list>(<argument><expr><name>pub_key</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block">/*
     * Check the result
     */</comment>
    <if>if <condition>(<expr><name>rc</name> <operator>&lt;</operator> <literal type="number">0</literal></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"CSR signature check failed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><literal type="number">1</literal></expr>;</return>
    }</block></then> <elseif>else <if>if <condition>(<expr><name>rc</name> <operator>==</operator> <literal type="number">0</literal></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"CSR signature mismatch"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><literal type="number">1</literal></expr>;</return>
    }</block></then></if></elseif> <else>else <block>{
        <return>return <expr><literal type="number">0</literal></expr>;</return>
    }</block></else></if>
}</block></function>


<comment type="block">/*
 * Frees the linked-list containing the attributes in
 * the client CSR.
 */</comment>
<function><specifier>static</specifier> <type><name>void</name></type> <name>est_server_free_csr_oid_list</name> <parameter_list>(<parameter><decl><type><name>EST_OID_LIST</name> <modifier>*</modifier></type><name>head</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>EST_OID_LIST</name> <modifier>*</modifier></type><name>next_entry</name></decl>;</decl_stmt>

    <if>if <condition>(<expr><operator>!</operator><name>head</name></expr>)</condition><then> <block>{
	<return>return;</return>
    }</block></then></if>

    <expr_stmt><expr><name>next_entry</name> <operator>=</operator> <name><name>head</name><operator>-&gt;</operator><name>next</name></name></expr>;</expr_stmt>
    <while>while <condition>(<expr><name>next_entry</name></expr>)</condition> <block>{
	<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>head</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><name>head</name> <operator>=</operator> <name>next_entry</name></expr>;</expr_stmt>
	<expr_stmt><expr><name>next_entry</name> <operator>=</operator> <name><name>head</name><operator>-&gt;</operator><name>next</name></name></expr>;</expr_stmt>
    }</block></while>
    <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>head</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
}</block></function>

<comment type="block">/*
 * Adds a new entry to the tail of the list of attributes
 * in the client CSR.
 */</comment>
<function><specifier>static</specifier> <type><name>void</name></type> <name>est_server_add_oid_to_list</name> <parameter_list>(<parameter><decl><type><name>EST_OID_LIST</name> <modifier>*</modifier><modifier>*</modifier></type><name>list</name></decl></parameter>, <parameter><decl><type><name>EST_OID_LIST</name> <modifier>*</modifier></type><name>new_entry</name></decl></parameter>)</parameter_list> 
<block>{
    <decl_stmt><decl><type><name>EST_OID_LIST</name> <modifier>*</modifier></type><name>head</name> <init>= <expr><operator>*</operator><name>list</name></expr></init></decl>;</decl_stmt>

    <comment type="block">/*
     * If the list doesn't have a head yet, the new entry
     * simply becomes the head
     */</comment>
    <if>if <condition>(<expr><name>head</name> <operator>==</operator> <name>NULL</name></expr>)</condition><then> <block>{ 
	<expr_stmt><expr><operator>*</operator><name>list</name> <operator>=</operator> <name>new_entry</name></expr>;</expr_stmt>
    }</block></then> <else>else <block>{
	<comment type="block">/*
	 * Walk the list to find the tail, add the new entry to the end
	 */</comment>
	<while>while <condition>(<expr><name><name>head</name><operator>-&gt;</operator><name>next</name></name></expr>)</condition> <block>{
	    <expr_stmt><expr><name>head</name> <operator>=</operator> <name><name>head</name><operator>-&gt;</operator><name>next</name></name></expr>;</expr_stmt>
	}</block></while>
	<expr_stmt><expr><name><name>head</name><operator>-&gt;</operator><name>next</name></name> <operator>=</operator> <name>new_entry</name></expr>;</expr_stmt>
    }</block></else></if>
}</block></function>

<comment type="block">/*
 * This is a recursive routine that walks through an ASN.1 blob
 * looking for ASN.1 object definitions.  For any that are
 * found, the OID for the object is added to the EST_OID_LIST (first argument).
 * The end result of this routine is **list will contain all the OID
 * values for every ASN.1 object in the blob.
 * This code was shamelessly taken from OpenSSL ans1_parse2(), which
 * explains some of the poorly chosen variable names.
 */</comment>
<function><specifier>static</specifier> <type><name>int</name></type> <name>est_server_csr_asn1_parse</name> <parameter_list>(<parameter><decl><type><name>EST_OID_LIST</name> <modifier>*</modifier><modifier>*</modifier></type><name>list</name></decl></parameter>, <parameter><decl><type><specifier>const</specifier> <name>unsigned</name> <name>char</name> <modifier>*</modifier><modifier>*</modifier></type><name>blob</name></decl></parameter>, <parameter><decl><type><name>long</name></type> <name>length</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>offset</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>EST_OID_LIST</name> <modifier>*</modifier></type><name>new_entry</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><specifier>const</specifier> <name>unsigned</name> <name>char</name> <modifier>*</modifier></type><name>ptr</name></decl>, <modifier>*</modifier><decl><type ref="prev"/><name>ep</name></decl>, <modifier>*</modifier><decl><type ref="prev"/><name>tot</name></decl>, <modifier>*</modifier><decl><type ref="prev"/><name>op</name></decl>, <modifier>*</modifier><decl><type ref="prev"/><name>opp</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>long</name></type> <name>len</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>tag</name></decl>, <decl><type ref="prev"/><name>xclass</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>hl</name></decl>, <decl><type ref="prev"/><name>j</name></decl>, <decl><type ref="prev"/><name>r</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>ASN1_OBJECT</name> <modifier>*</modifier></type><name>a_object</name> <init>= <expr><name>NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>errno_t</name></type> <name>safec_rc</name></decl>;</decl_stmt> 

    <expr_stmt><expr><name>ptr</name> <operator>=</operator> <operator>*</operator><name>blob</name></expr>;</expr_stmt>
    <expr_stmt><expr><name>tot</name> <operator>=</operator> <name>ptr</name> <operator>+</operator> <name>length</name></expr>;</expr_stmt>
    <expr_stmt><expr><name>op</name> <operator>=</operator> <name>ptr</name> <operator>-</operator> <literal type="number">1</literal></expr>;</expr_stmt>
    <while>while <condition>(<expr><operator>(</operator><name>ptr</name> <operator>&lt;</operator> <name>tot</name><operator>)</operator> <operator>&amp;&amp;</operator> <operator>(</operator><name>op</name> <operator>&lt;</operator> <name>ptr</name><operator>)</operator></expr>)</condition> <block>{
	<expr_stmt><expr><name>op</name> <operator>=</operator> <name>ptr</name></expr>;</expr_stmt>
	<expr_stmt><expr><name>j</name> <operator>=</operator> <call><name>ASN1_get_object</name><argument_list>(<argument><expr><operator>&amp;</operator><name>ptr</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>len</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>tag</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>xclass</name></expr></argument>, <argument><expr><name>length</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><name>j</name> <operator>&amp;</operator> <literal type="number">0x80</literal></expr>)</condition><then> <block>{
	    <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Error in encoding"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt> 
	    <expr_stmt><expr><operator>*</operator><name>blob</name> <operator>=</operator> <name>ptr</name></expr>;</expr_stmt>
	    <return>return <expr><operator>(</operator><literal type="number">0</literal><operator>)</operator></expr>;</return>
	}</block></then></if>
	<expr_stmt><expr><name>hl</name> <operator>=</operator> <name>ptr</name> <operator>-</operator> <name>op</name></expr>;</expr_stmt>
	<expr_stmt><expr><name>length</name> <operator>-=</operator> <name>hl</name></expr>;</expr_stmt>

	<if>if <condition>(<expr><name>j</name> <operator>&amp;</operator> <name>V_ASN1_CONSTRUCTED</name></expr>)</condition><then> <block>{
	    <expr_stmt><expr><name>ep</name> <operator>=</operator> <name>ptr</name> <operator>+</operator> <name>len</name></expr>;</expr_stmt>
	    <if>if <condition>(<expr><name>len</name> <operator>&gt;</operator> <name>length</name></expr>)</condition><then> <block>{
		<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"length is greater than %ld"</literal></expr></argument>,<argument><expr><name>length</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<expr_stmt><expr><operator>*</operator><name>blob</name> <operator>=</operator> <name>ptr</name></expr>;</expr_stmt>
		<return>return <expr><operator>(</operator><literal type="number">0</literal><operator>)</operator></expr>;</return>
	    }</block></then></if>
	    <if>if <condition>(<expr><operator>(</operator><name>j</name> <operator>==</operator> <literal type="number">0x21</literal><operator>)</operator> <operator>&amp;&amp;</operator> <operator>(</operator><name>len</name> <operator>==</operator> <literal type="number">0</literal><operator>)</operator></expr>)</condition><then> <block>{
		<expr_stmt><expr><name>r</name> <operator>=</operator> <call><name>est_server_csr_asn1_parse</name><argument_list>(<argument><expr><name>list</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>ptr</name></expr></argument>, <argument><expr><call>(<name>long</name>)<argument_list>(<argument><expr><name>tot</name><operator>-</operator><name>ptr</name></expr></argument>)</argument_list></call></expr></argument>, <argument><expr><name>offset</name><operator>+</operator><operator>(</operator><name>ptr</name> <operator>-</operator> <operator>*</operator><name>blob</name><operator>)</operator></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<if>if <condition>(<expr><name>r</name> <operator>==</operator> <literal type="number">0</literal></expr>)</condition><then> <block>{ 
		    <expr_stmt><expr><operator>*</operator><name>blob</name> <operator>=</operator> <name>ptr</name></expr>;</expr_stmt>
		    <return>return <expr><operator>(</operator><literal type="number">0</literal><operator>)</operator></expr>;</return>
		}</block></then></if>
		<if>if <condition>(<expr><operator>(</operator><name>r</name> <operator>==</operator> <literal type="number">2</literal><operator>)</operator> <operator>||</operator> <operator>(</operator><name>ptr</name> <operator>&gt;=</operator> <name>tot</name><operator>)</operator></expr>)</condition><then> <block type="pseudo"><break>break;</break></block></then></if>
	    }</block></then> <else>else <block>{
		<while>while <condition>(<expr><name>ptr</name> <operator>&lt;</operator> <name>ep</name></expr>)</condition> <block>{
		    <expr_stmt><expr><name>r</name> <operator>=</operator> <call><name>est_server_csr_asn1_parse</name><argument_list>(<argument><expr><name>list</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>ptr</name></expr></argument>, <argument><expr><operator>(</operator><name>long</name><operator>)</operator><name>len</name></expr></argument>, <argument><expr><name>offset</name><operator>+</operator><operator>(</operator><name>ptr</name> <operator>-</operator> <operator>*</operator><name>blob</name><operator>)</operator></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		    <if>if <condition>(<expr><name>r</name> <operator>==</operator> <literal type="number">0</literal></expr>)</condition><then> <block>{ 
			<expr_stmt><expr><operator>*</operator><name>blob</name> <operator>=</operator> <name>ptr</name></expr>;</expr_stmt>
			<return>return <expr><operator>(</operator><literal type="number">0</literal><operator>)</operator></expr>;</return>
		    }</block></then></if>
		}</block></while>
	    }</block></else></if>
	}</block></then> <elseif>else <if>if <condition>(<expr><name>xclass</name> <operator>!=</operator> <literal type="number">0</literal></expr>)</condition><then> <block>{
	    <expr_stmt><expr><name>ptr</name> <operator>+=</operator> <name>len</name></expr>;</expr_stmt>
	}</block></then></if></elseif> <else>else <block>{
	    <if>if <condition>(<expr><name>tag</name> <operator>==</operator> <name>V_ASN1_OBJECT</name></expr>)</condition><then> <block>{
		<expr_stmt><expr><name>opp</name> <operator>=</operator> <name>op</name></expr>;</expr_stmt>
		<if>if <condition>(<expr><call><name>d2i_ASN1_OBJECT</name><argument_list>(<argument><expr><operator>&amp;</operator><name>a_object</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>opp</name></expr></argument>, <argument><expr><name>len</name><operator>+</operator><name>hl</name></expr></argument>)</argument_list></call> <operator>!=</operator> <name>NULL</name></expr>)</condition><then> <block>{
		    <expr_stmt><expr><name>new_entry</name> <operator>=</operator> <call><name>malloc</name><argument_list>(<argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name>EST_OID_LIST</name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		    <if>if <condition>(<expr><operator>!</operator><name>new_entry</name></expr>)</condition><then> <block>{
			<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"malloc failure"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
			<expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><operator>*</operator><name>list</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
			<if>if <condition>(<expr><name>a_object</name> <operator>!=</operator> <name>NULL</name></expr>)</condition><then> <block>{ <expr_stmt><expr><call><name>ASN1_OBJECT_free</name><argument_list>(<argument><expr><name>a_object</name></expr></argument>)</argument_list></call></expr>;</expr_stmt> }</block></then></if>
			<expr_stmt><expr><operator>*</operator><name>blob</name> <operator>=</operator> <name>ptr</name></expr>;</expr_stmt>
			<return>return <expr><operator>(</operator><literal type="number">0</literal><operator>)</operator></expr>;</return>
		    }</block></then></if>
		    <expr_stmt><expr><name>safec_rc</name> <operator>=</operator> <call><name>memset_s</name><argument_list>(<argument><expr><name>new_entry</name></expr></argument>, <argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name>EST_OID_LIST</name></expr></argument>)</argument_list></sizeof></expr></argument>, <argument><expr><literal type="number">0x0</literal></expr></argument>, <argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name>EST_OID_LIST</name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		    <if>if <condition>(<expr><name>safec_rc</name> <operator>!=</operator> <name>EOK</name></expr>)</condition><then> <block>{
		        <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"memset_s error 0x%xO\n"</literal></expr></argument>, <argument><expr><name>safec_rc</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		    }</block></then></if>
		    <expr_stmt><expr><call><name>i2t_ASN1_OBJECT</name><argument_list>(<argument><expr><name><name>new_entry</name><operator>-&gt;</operator><name>oid</name></name></expr></argument>, <argument><expr><name>EST_MAX_ATTR_LEN</name></expr></argument>, <argument><expr><name>a_object</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		    <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"Build CSR OID list: %s"</literal></expr></argument>, <argument><expr><name><name>new_entry</name><operator>-&gt;</operator><name>oid</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		    <expr_stmt><expr><call><name>est_server_add_oid_to_list</name><argument_list>(<argument><expr><name>list</name></expr></argument>, <argument><expr><name>new_entry</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		    <if>if <condition>(<expr><name>a_object</name> <operator>!=</operator> <name>NULL</name></expr>)</condition><then> <block>{
			<expr_stmt><expr><call><name>ASN1_OBJECT_free</name><argument_list>(<argument><expr><name>a_object</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
			<expr_stmt><expr><name>a_object</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
		    }</block></then></if>
		}</block></then> <else>else <block>{
		    <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Bad ASN.1 object"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		    <if>if <condition>(<expr><name>a_object</name> <operator>!=</operator> <name>NULL</name></expr>)</condition><then> <block>{ <expr_stmt><expr><call><name>ASN1_OBJECT_free</name><argument_list>(<argument><expr><name>a_object</name></expr></argument>)</argument_list></call></expr>;</expr_stmt> }</block></then></if>
		    <expr_stmt><expr><operator>*</operator><name>blob</name> <operator>=</operator> <name>ptr</name></expr>;</expr_stmt>
		    <return>return <expr><operator>(</operator><literal type="number">0</literal><operator>)</operator></expr>;</return>
		}</block></else></if>
	    }</block></then></if> 
	    <expr_stmt><expr><name>ptr</name> <operator>+=</operator> <name>len</name></expr>;</expr_stmt>
	    <if>if <condition>(<expr><operator>(</operator><name>tag</name> <operator>==</operator> <name>V_ASN1_EOC</name><operator>)</operator> <operator>&amp;&amp;</operator> <operator>(</operator><name>xclass</name> <operator>==</operator> <literal type="number">0</literal><operator>)</operator></expr>)</condition><then> <block>{
		<expr_stmt><expr><operator>*</operator><name>blob</name> <operator>=</operator> <name>ptr</name></expr>;</expr_stmt>
		<return>return <expr><operator>(</operator><literal type="number">2</literal><operator>)</operator></expr>;</return>
	    }</block></then></if>
	}</block></else></if>
	<expr_stmt><expr><name>length</name> <operator>-=</operator> <name>len</name></expr>;</expr_stmt>
    }</block></while>
    <expr_stmt><expr><operator>*</operator><name>blob</name> <operator>=</operator> <name>ptr</name></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><literal type="number">1</literal><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*
 * Utility function that populates a linked-list containing
 * the OID (or name) of the attributes present in the
 * client CSR.
 */</comment>
<function><specifier>static</specifier> <type><name>EST_ERROR</name></type> <name>est_server_build_csr_oid_list</name> <parameter_list>(<parameter><decl><type><name>EST_OID_LIST</name> <modifier>*</modifier><modifier>*</modifier></type><name>list</name></decl></parameter>, <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>body</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>body_len</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>unsigned</name> <name>char</name> <modifier>*</modifier></type><name>der_data</name></decl>, <modifier>*</modifier><decl><type ref="prev"/><name>der_ptr</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>der_len</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>rv</name></decl>;</decl_stmt>

    <comment type="block">/*
     * grab some space to hold the decoded CSR data
     */</comment>
    <expr_stmt><expr><name>der_ptr</name> <operator>=</operator> <name>der_data</name> <operator>=</operator> <call><name>malloc</name><argument_list>(<argument><expr><name>body_len</name><operator>*</operator><literal type="number">2</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><operator>!</operator><name>der_data</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"malloc failed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_MALLOC</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Decode the CSR data
     */</comment>
    <expr_stmt><expr><name>der_len</name> <operator>=</operator> <call><name>est_base64_decode</name><argument_list>(<argument><expr><operator>(</operator><name>char</name> <operator>*</operator><operator>)</operator><name>body</name></expr></argument>, <argument><expr><operator>(</operator><name>char</name> <operator>*</operator><operator>)</operator><name>der_data</name></expr></argument>, <argument><expr><name>body_len</name><operator>*</operator><literal type="number">2</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><name>der_len</name> <operator>&lt;=</operator> <literal type="number">0</literal></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Invalid base64 encoded data"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>der_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_BAD_BASE64</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name>est_server_csr_asn1_parse</name><argument_list>(<argument><expr><name>list</name></expr></argument>, <argument><expr><operator>(</operator><specifier>const</specifier> <name>unsigned</name> <name>char</name> <operator>*</operator><operator>*</operator><operator>)</operator><operator>&amp;</operator><name>der_data</name></expr></argument>, <argument><expr><name>der_len</name></expr></argument>, <argument><expr><literal type="number">0</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><operator>!</operator><name>rv</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Failed to build OID list from client provided CSR"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><operator>*</operator><name>list</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>der_ptr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return>return <expr><operator>(</operator><name>EST_ERR_UNKNOWN</name><operator>)</operator></expr>;</return>
    }</block></then></if>
    <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>der_ptr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*
 * This function checks the locally configured CSR attributes
 * against the attributes in the CSR.  If any attributes are
 * missing from the CSR, then an error is returned.
 */</comment>
<function><specifier>static</specifier> <type><name>EST_ERROR</name></type> <name>est_server_all_csrattrs_present</name><parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>body</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>body_len</name></decl></parameter>)</parameter_list> 
<block>{
    <decl_stmt><decl><type><name>int</name></type> <name>tag</name></decl>, <decl><type ref="prev"/><name>xclass</name></decl>, <decl><type ref="prev"/><name>j</name></decl>, <decl><type ref="prev"/><name>found_match</name></decl>, <decl><type ref="prev"/><name>nid</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>long</name></type> <name>len</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>unsigned</name> <name>char</name> <modifier>*</modifier></type><name>der_ptr</name></decl>, <modifier>*</modifier><decl><type ref="prev"/><name>save_ptr</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>ASN1_OBJECT</name> <modifier>*</modifier></type><name>a_object</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>max_len</name> <init>= <expr><name>MAX_CSRATTRS</name></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>char</name> <modifier>*</modifier></type><name>csr_data</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>csr_len</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>long</name></type> <name>out_len_save</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>unsigned</name> <name>char</name> <modifier>*</modifier></type><name>der_data</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>der_len</name></decl>, <decl><type ref="prev"/><name>out_len</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>a_len</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>char</name></type> <name><name>tbuf</name><index>[<expr><name>EST_MAX_ATTR_LEN</name></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>EST_OID_LIST</name> <modifier>*</modifier></type><name>csr_attr_oids</name> <init>= <expr><name>NULL</name></expr></init></decl>;</decl_stmt> 
    <decl_stmt><decl><type><name>EST_OID_LIST</name> <modifier>*</modifier></type><name>oid_entry</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>comparator</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>EST_ERROR</name></type> <name>rv</name></decl>;</decl_stmt>

    <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"CSR attributes enforcement is enabled"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <if>if <condition>(<expr><operator>!</operator><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs</name></name> <operator>&amp;&amp;</operator> <operator>!</operator><name><name>ctx</name><operator>-&gt;</operator><name>est_get_csr_cb</name></name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"CSR attributes enforcement is enabled, but no attributes have been configured"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return>return <expr><name>EST_ERR_NONE</name></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Build the list of attributes present in the CSR.  This list will be
     * used later when we confirm the required attributes are present.
     */</comment>
    <expr_stmt><expr><name>rv</name> <operator>=</operator>  <call><name>est_server_build_csr_oid_list</name><argument_list>(<argument><expr><operator>&amp;</operator><name>csr_attr_oids</name></expr></argument>, <argument><expr><name>body</name></expr></argument>, <argument><expr><name>body_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><name>rv</name> <operator>!=</operator> <name>EST_ERR_NONE</name></expr>)</condition><then> <block>{
	<return>return <expr><operator>(</operator><name>rv</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Get the CSR attributes configured on the server.  We'll need to 
     * look in the CSR to make sure the CSR provided each of these. 
     * Use the callback if configured, otherwise use the local copy.
     */</comment>
    <if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>est_get_csr_cb</name></name></expr>)</condition><then> <block>{
	<expr_stmt><expr><name>csr_data</name> <operator>=</operator> <operator>(</operator><name>char</name> <operator>*</operator><operator>)</operator><call><name><name>ctx</name><operator>-&gt;</operator><name>est_get_csr_cb</name></name><argument_list>(<argument><expr><operator>&amp;</operator><name>csr_len</name></expr></argument>, <argument><expr><name>NULL</name></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>ex_data</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><operator>!</operator><name>csr_data</name></expr>)</condition><then> <block>{
	    <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Application layer failed to return CSR attributes"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><name>csr_attr_oids</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <return>return <expr><operator>(</operator><name>EST_ERR_CB_FAILED</name><operator>)</operator></expr>;</return>
	}</block></then></if>
    }</block></then> <else>else <block>{
        <expr_stmt><expr><name>csr_data</name> <operator>=</operator> <call><name>malloc</name><argument_list>(<argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name> <operator>+</operator> <literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><operator>!</operator><name>csr_data</name></expr>)</condition><then> <block>{
	    <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"malloc failure"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><name>csr_attr_oids</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>EST_ERR_MALLOC</name><operator>)</operator></expr>;</return>
        }</block></then></if>
        <expr_stmt><expr><call><name>strncpy_s</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name> <operator>+</operator> <literal type="number">1</literal></expr></argument>, 
		  <argument><expr><operator>(</operator><name>char</name> <operator>*</operator><operator>)</operator><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs</name></name></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><name><name>csr_data</name><index>[<expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name></expr>]</index></name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
	<expr_stmt><expr><name>csr_len</name> <operator>=</operator> <name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name></expr>;</expr_stmt>
    }</block></else></if>
    <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"Checking CSR attrs present in CSR: %s"</literal></expr></argument>, <argument><expr><name>csr_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block">/* 
     * We have the CSR configured on the server and it needs base64 decoding.
     * Check smallest possible base64 case here for now 
     * and sanity test will check min/max value for ASN.1 data
     */</comment>
    <if>if <condition>(<expr><name>csr_len</name> <operator>&lt;</operator> <name>MIN_CSRATTRS</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><name>csr_attr_oids</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_INVALID_PARAMETERS</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * grab some space to hold the decoded CSR data
     */</comment>
    <expr_stmt><expr><name>der_data</name> <operator>=</operator> <call><name>malloc</name><argument_list>(<argument><expr><name>csr_len</name><operator>*</operator><literal type="number">2</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><operator>!</operator><name>der_data</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"malloc failed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><name>csr_attr_oids</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_MALLOC</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Decode the CSR data
     */</comment>
    <expr_stmt><expr><name>der_len</name> <operator>=</operator> <call><name>est_base64_decode</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>, <argument><expr><operator>(</operator><name>char</name> <operator>*</operator><operator>)</operator><name>der_data</name></expr></argument>, <argument><expr><name>csr_len</name><operator>*</operator><literal type="number">2</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><name>der_len</name> <operator>&lt;=</operator> <literal type="number">0</literal></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Invalid base64 encoded data"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><name>csr_attr_oids</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>der_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_BAD_BASE64</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * pointer fun starts here, joy to OpenSSL
     */</comment>
    <expr_stmt><expr><name>out_len_save</name> <operator>=</operator> <name>out_len</name> <operator>=</operator> <name>der_len</name></expr>;</expr_stmt>
    <expr_stmt><expr><name>der_ptr</name> <operator>=</operator> <name>save_ptr</name> <operator>=</operator> <name>der_data</name></expr>;</expr_stmt>

    <if>if <condition>(<expr><name>out_len_save</name> <operator>&gt;</operator> <name>max_len</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"DER length exceeds max"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><name>csr_attr_oids</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>der_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_INVALID_PARAMETERS</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/* make sure its long enough to be ASN.1 */</comment>
    <if>if <condition>(<expr><name>der_len</name> <operator>&lt;</operator> <name>MIN_ASN1_CSRATTRS</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"DER too short"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><name>csr_attr_oids</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>der_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_INVALID_PARAMETERS</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Iterate through the CSR attributes configured on the server
     */</comment>
    <while>while <condition>(<expr><name>out_len</name> <operator>&gt;</operator> <literal type="number">0</literal></expr>)</condition> <block>{
	<comment type="block">/*
	 * Get the next attributes
	 */</comment>
	<expr_stmt><expr><name>j</name> <operator>=</operator> <call><name>ASN1_get_object</name><argument_list>(<argument><expr><operator>(</operator><specifier>const</specifier> <name>unsigned</name> <name>char</name><operator>*</operator><operator>*</operator><operator>)</operator><operator>&amp;</operator><name>der_ptr</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>len</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>tag</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>xclass</name></expr></argument>, <argument><expr><name>out_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

	<expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"Sanity: tag=%d, len=%d, j=%d, out_len=%d"</literal></expr></argument>, <argument><expr><name>tag</name></expr></argument>, <argument><expr><name>len</name></expr></argument>, <argument><expr><name>j</name></expr></argument>, <argument><expr><name>out_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><name>j</name> <operator>&amp;</operator> <literal type="number">0x80</literal></expr>)</condition><then> <block>{
	    <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Bad ASN1 hex"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><name>csr_attr_oids</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>der_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <return>return <expr><operator>(</operator><name>EST_ERR_BAD_ASN1_HEX</name><operator>)</operator></expr>;</return>
        }</block></then></if>
	<switch>switch <condition>(<expr><name>tag</name></expr>)</condition> <block>{
	<case>case <expr><name>V_ASN1_OBJECT</name></expr>:</case>
            <expr_stmt><expr><name>a_object</name> <operator>=</operator> <call><name>c2i_ASN1_OBJECT</name><argument_list>(<argument><expr><name>NULL</name></expr></argument>, <argument><expr><operator>(</operator><specifier>const</specifier> <name>unsigned</name> <name>char</name><operator>*</operator><operator>*</operator><operator>)</operator><operator>&amp;</operator><name>der_ptr</name></expr></argument>, <argument><expr><name>len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <if>if <condition>(<expr><operator>!</operator><name>a_object</name></expr>)</condition><then> <block>{
		<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"a_object is null"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	        <expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><name>csr_attr_oids</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>der_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<return>return <expr><operator>(</operator><name>EST_ERR_UNKNOWN</name><operator>)</operator></expr>;</return>
	    }</block></then></if>
	    <comment type="block">/*
	     * If this is the challengePassword, no need to check it.
	     * This is already covered when authenticating the client
	     */</comment>
	    <expr_stmt><expr><name>nid</name> <operator>=</operator> <call><name>OBJ_obj2nid</name><argument_list>(<argument><expr><name>a_object</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <if>if <condition>(<expr><name>nid</name> <operator>==</operator> <name>NID_pkcs9_challengePassword</name></expr>)</condition><then> <block>{
		<expr_stmt><expr><call><name>ASN1_OBJECT_free</name><argument_list>(<argument><expr><name>a_object</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<break>break;</break>
	    }</block></then></if>

	    <expr_stmt><expr><name>a_len</name> <operator>=</operator> <call><name>i2t_ASN1_OBJECT</name><argument_list>(<argument><expr><name>tbuf</name></expr></argument>, <argument><expr><name>EST_MAX_ATTR_LEN</name></expr></argument>, <argument><expr><name>a_object</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"Looking for attr=%s in the CSR"</literal></expr></argument>, <argument><expr><name>tbuf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><call><name>ASN1_OBJECT_free</name><argument_list>(<argument><expr><name>a_object</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

	    <comment type="block">/*
	     * If there were no attrubutes in the CSR, we can
	     * bail now.
	     */</comment>
	    <if>if <condition>(<expr><name>csr_attr_oids</name> <operator>==</operator> <name>NULL</name></expr>)</condition><then> <block>{
		<expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"CSR did not contain any attributes, CSR will be rejected"</literal></expr></argument>, <argument><expr><name>tbuf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>der_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	        <return>return <expr><operator>(</operator><name>EST_ERR_CSR_ATTR_MISSING</name><operator>)</operator></expr>;</return>
	    }</block></then></if>

	    <expr_stmt><expr><name>found_match</name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
	    <expr_stmt><expr><name>oid_entry</name> <operator>=</operator> <name>csr_attr_oids</name></expr>;</expr_stmt>
	    <comment type="block">/*
	     * Iterate through the attributes that are in the CSR
	     */</comment>
	    <while>while <condition>(<expr><name>oid_entry</name></expr>)</condition> <block>{ 
		<expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"Comparing %s to %s"</literal></expr></argument>, <argument><expr><name>tbuf</name></expr></argument>, <argument><expr><name><name>oid_entry</name><operator>-&gt;</operator><name>oid</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<expr_stmt><expr><call><name>strcmp_s</name><argument_list>(<argument><expr><name><name>oid_entry</name><operator>-&gt;</operator><name>oid</name></name></expr></argument>, <argument><expr><operator>(</operator><ternary><condition><expr><name>a_len</name> <operator>&lt;</operator> <name>EST_MAX_ATTR_LEN</name></expr> ?</condition><then> <expr><name>a_len</name></expr> </then><else>: <expr><name>EST_MAX_ATTR_LEN</name></expr></else></ternary><operator>)</operator></expr></argument>, <argument><expr><name>tbuf</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>comparator</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<if>if <condition>(<expr><operator>!</operator><name>comparator</name></expr>)</condition><then> <block>{
		    <expr_stmt><expr><name>found_match</name> <operator>=</operator> <literal type="number">1</literal></expr>;</expr_stmt>
		    <break>break;</break>
		}</block></then></if>
		<expr_stmt><expr><name>oid_entry</name> <operator>=</operator> <name><name>oid_entry</name><operator>-&gt;</operator><name>next</name></name></expr>;</expr_stmt>
	    }</block></while> 

	    <if>if <condition>(<expr><operator>!</operator><name>found_match</name></expr>)</condition><then> <block>{
		<expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"CSR did not contain %s attribute, CSR will be rejected"</literal></expr></argument>, <argument><expr><name>tbuf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	        <expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><name>csr_attr_oids</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>der_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	        <return>return <expr><operator>(</operator><name>EST_ERR_CSR_ATTR_MISSING</name><operator>)</operator></expr>;</return>
	    }</block></then></if>
	    <break>break;</break>
	<default>default:</default>
	    <comment type="block">/* have to adjust string pointer here, move on to the next item */</comment>
	    <expr_stmt><expr><name>der_ptr</name> <operator>+=</operator> <name>len</name></expr>;</expr_stmt>
	    <break>break;</break>
	<case>case <expr><name>V_ASN1_SET</name></expr>:</case>
	<case>case <expr><name>V_ASN1_SEQUENCE</name></expr>:</case>
	    <break>break;</break>
	}</block></switch>
	<expr_stmt><expr><name>out_len</name> <operator>=</operator> <name>out_len_save</name> <operator>-</operator> <operator>(</operator><name>der_ptr</name> <operator>-</operator> <name>save_ptr</name><operator>)</operator></expr>;</expr_stmt>
    }</block></while>
    
    <comment type="block">/*
     * One file check to ensure we didn't missing something when parsing
     * the locally configured CSR attributes.
     */</comment>
    <if>if <condition>(<expr><name>out_len</name> <operator>!=</operator> <literal type="number">0</literal></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"DER length not zero (%d)"</literal></expr></argument>, <argument><expr><name>out_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><name>csr_attr_oids</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>der_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_BAD_ASN1_HEX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * If we're lucky enough to make it this far, then it means all the
     * locally configured CSR attributes were found in the client's CSR.
     */</comment>
    <expr_stmt><expr><call><name>est_server_free_csr_oid_list</name><argument_list>(<argument><expr><name>csr_attr_oids</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>der_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*
 * This function is used by the server to process an incoming
 * Simple Enroll request from the client.
 */</comment>
<function><specifier>static</specifier> <type><name>EST_ERROR</name></type> <name>est_handle_simple_enroll</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>void</name> <modifier>*</modifier></type><name>http_ctx</name></decl></parameter>, <parameter><decl><type><name>SSL</name> <modifier>*</modifier></type><name>ssl</name></decl></parameter>,
                                           <parameter><decl><type><specifier>const</specifier> <name>char</name> <modifier>*</modifier></type><name>ct</name></decl></parameter>, <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>body</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>body_len</name></decl></parameter>,
                                           <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>path_seg</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>reenroll</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>int</name></type> <name>rv</name></decl>, <decl><type ref="prev"/><name>cert_len</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name><name>struct</name> <name>mg_connection</name></name> <modifier>*</modifier></type><name>conn</name> <init>= <expr><operator>(</operator>struct <name>mg_connection</name><operator>*</operator><operator>)</operator><name>http_ctx</name></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>unsigned</name> <name>char</name> <modifier>*</modifier></type><name>cert</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>char</name></type> <name><name>http_hdr</name><index>[<expr><name>EST_HTTP_HDR_MAX</name></expr>]</index></name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>hdrlen</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>X509</name> <modifier>*</modifier></type><name>peer_cert</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>X509_REQ</name> <modifier>*</modifier></type><name>csr</name> <init>= <expr><name>NULL</name></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>client_is_ra</name> <init>= <expr><literal type="number">0</literal></expr></init></decl>;</decl_stmt>

    <if>if <condition>(<expr><operator>!</operator><name>reenroll</name> <operator>&amp;&amp;</operator> <operator>!</operator><name><name>ctx</name><operator>-&gt;</operator><name>est_enroll_pkcs10_cb</name></name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null enrollment callback"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NULL_CALLBACK</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <if>if <condition>(<expr><name>reenroll</name> <operator>&amp;&amp;</operator> <operator>!</operator><name><name>ctx</name><operator>-&gt;</operator><name>est_reenroll_pkcs10_cb</name></name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null reenroll callback"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NULL_CALLBACK</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Make sure the client has sent us a PKCS10 CSR request
     */</comment>
    <if>if <condition>(<expr><call><name>strncmp</name><argument_list>(<argument><expr><name>ct</name></expr></argument>, <argument><expr><literal type="string">"application/pkcs10"</literal></expr></argument>, <argument><expr><literal type="number">18</literal></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
        <return>return <expr><operator>(</operator><name>EST_ERR_BAD_CONTENT_TYPE</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Authenticate the client
     */</comment>
    <switch>switch <condition>(<expr><call><name>est_enroll_auth</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>ssl</name></expr></argument>, <argument><expr><name>path_seg</name></expr></argument>, <argument><expr><name>reenroll</name></expr></argument>)</argument_list></call></expr>)</condition> <block>{
    <case>case <expr><name>EST_HTTP_AUTH</name></expr>:</case>
    <case>case <expr><name>EST_SRP_AUTH</name></expr>:</case>
    <case>case <expr><name>EST_CERT_AUTH</name></expr>:</case>
	<comment type="block">/*
	 * this means the user was authorized, either through
	 * HTTP authoriztion or certificate authorization
	 */</comment>
        <break>break;</break>
    <case>case <expr><name>EST_HTTP_AUTH_PENDING</name></expr>:</case>
        <return>return <expr><operator>(</operator><name>EST_ERR_AUTH_PENDING</name><operator>)</operator></expr>;</return>
        <break>break;</break>
    <case>case <expr><name>EST_UNAUTHORIZED</name></expr>:</case>
    <default>default:</default>
        <return>return <expr><operator>(</operator><name>EST_ERR_AUTH_FAIL</name><operator>)</operator></expr>;</return>
        <break>break;</break>
    }</block></switch>

    <comment type="block">/*
     * Parse the PKCS10 CSR from the client
     */</comment>
    <expr_stmt><expr><name>csr</name> <operator>=</operator> <call><name>est_server_parse_csr</name><argument_list>(<argument><expr><operator>(</operator><name>unsigned</name> <name>char</name><operator>*</operator><operator>)</operator><name>body</name></expr></argument>, <argument><expr><name>body_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><operator>!</operator><name>csr</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Unable to parse the PKCS10 CSR sent by the client"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return>return <expr><operator>(</operator><name>EST_ERR_BAD_PKCS10</name><operator>)</operator></expr>;</return>
    }</block></then></if>
    
    <comment type="block">/*
     * Perform a sanity check on the CSR
     */</comment>
    <if>if <condition>(<expr><call><name>est_server_check_csr</name><argument_list>(<argument><expr><name>csr</name></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"PKCS10 CSR sent by the client failed sanity check"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>X509_REQ_free</name><argument_list>(<argument><expr><name>csr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return>return <expr><operator>(</operator><name>EST_ERR_BAD_PKCS10</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Get the peer certificate if available.  This
     * identifies the client. The CA may desire
     * this information.
     */</comment>
    <expr_stmt><expr><name>peer_cert</name> <operator>=</operator> <call><name>SSL_get_peer_certificate</name><argument_list>(<argument><expr><name>ssl</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <if>if <condition>(<expr><name>peer_cert</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><name>client_is_ra</name> <operator>=</operator> <call><name>est_check_cmcRA</name> <argument_list>(<argument><expr><name>peer_cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></then></if>
    <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"id-kp-cmcRA present: %d"</literal></expr></argument>, <argument><expr><name>client_is_ra</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block">/*
     * Do the PoP check (Proof of Possession).  The challenge password
     * in the pkcs10 request should match the TLS unique ID.
     * The PoP check is not performend when the client is an RA.
     */</comment>
    <if>if <condition>(<expr><operator>!</operator><name>client_is_ra</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name>est_tls_uid_auth</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>ssl</name></expr></argument>, <argument><expr><name>csr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><name>rv</name> <operator>!=</operator> <name>EST_ERR_NONE</name></expr>)</condition><then> <block>{
	    <expr_stmt><expr><call><name>X509_REQ_free</name><argument_list>(<argument><expr><name>csr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><call><name>X509_free</name><argument_list>(<argument><expr><name>peer_cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <return>return <expr><operator>(</operator><name>EST_ERR_AUTH_FAIL_TLSUID</name><operator>)</operator></expr>;</return>
	}</block></then></if> 
    }</block></then></if>

    <comment type="block">/*
     * Check if we need to ensure the client included all the
     * CSR attributes required by the CA.
     */</comment>
    <if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>enforce_csrattrs</name></name></expr>)</condition><then> <block>{
	<if>if <condition>(<expr><name>EST_ERR_NONE</name> <operator>!=</operator> <call><name>est_server_all_csrattrs_present</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>body</name></expr></argument>, <argument><expr><name>body_len</name></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
	    <expr_stmt><expr><call><name>X509_REQ_free</name><argument_list>(<argument><expr><name>csr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><call><name>X509_free</name><argument_list>(<argument><expr><name>peer_cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <return>return <expr><operator>(</operator><name>EST_ERR_CSR_ATTR_MISSING</name><operator>)</operator></expr>;</return>
	}</block></then></if>
    }</block></then></if>

    <comment type="block">/* body now points to the pkcs10 data, pass
     * this to the enrollment routine */</comment>
    <if>if <condition>(<expr><name>reenroll</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name><name>ctx</name><operator>-&gt;</operator><name>est_reenroll_pkcs10_cb</name></name><argument_list>(<argument><expr><operator>(</operator><name>unsigned</name> <name>char</name><operator>*</operator><operator>)</operator><name>body</name></expr></argument>, <argument><expr><name>body_len</name></expr></argument>, 
                                         <argument><expr><operator>&amp;</operator><name>cert</name></expr></argument>, <argument><expr><operator>(</operator><name>int</name><operator>*</operator><operator>)</operator><operator>&amp;</operator><name>cert_len</name></expr></argument>,
                                         <argument><expr><name><name>conn</name><operator>-&gt;</operator><name>user_id</name></name></expr></argument>, <argument><expr><name>peer_cert</name></expr></argument>,
                                         <argument><expr><name>path_seg</name></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>ex_data</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></then> <else>else <block>{
        <expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name><name>ctx</name><operator>-&gt;</operator><name>est_enroll_pkcs10_cb</name></name><argument_list>(<argument><expr><operator>(</operator><name>unsigned</name> <name>char</name><operator>*</operator><operator>)</operator><name>body</name></expr></argument>, <argument><expr><name>body_len</name></expr></argument>, 
                                       <argument><expr><operator>&amp;</operator><name>cert</name></expr></argument>, <argument><expr><operator>(</operator><name>int</name><operator>*</operator><operator>)</operator><operator>&amp;</operator><name>cert_len</name></expr></argument>,
                                       <argument><expr><name><name>conn</name><operator>-&gt;</operator><name>user_id</name></name></expr></argument>, <argument><expr><name>peer_cert</name></expr></argument>,
                                       <argument><expr><name>path_seg</name></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>ex_data</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></else></if>

    <comment type="block">/*
     * Peer cert is no longer needed, delete it if we have one
     */</comment>
    <if>if <condition>(<expr><name>peer_cert</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>X509_free</name><argument_list>(<argument><expr><name>peer_cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></then></if>

    <if>if <condition>(<expr><name>rv</name> <operator>==</operator> <name>EST_ERR_NONE</name> <operator>&amp;&amp;</operator> <name>cert_len</name> <operator>&gt;</operator> <literal type="number">0</literal></expr>)</condition><then> <block>{
        <comment type="block">/*
         * Send HTTP header
         */</comment>
        <expr_stmt><expr><call><name>snprintf</name><argument_list>(<argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>, <argument><expr><literal type="string">"%s%s%s%s"</literal></expr></argument>, <argument><expr><name>EST_HTTP_HDR_200</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>,
                 <argument><expr><name>EST_HTTP_HDR_STAT_200</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><name>hdrlen</name> <operator>=</operator> <call><name>strnlen_s</name><argument_list>(<argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>snprintf</name><argument_list>(<argument><expr><name>http_hdr</name> <operator>+</operator> <name>hdrlen</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>, <argument><expr><literal type="string">"%s: %s%s"</literal></expr></argument>, <argument><expr><name>EST_HTTP_HDR_CT</name></expr></argument>,
                 <argument><expr><name>EST_HTTP_CT_PKCS7_CO</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><name>hdrlen</name> <operator>=</operator> <call><name>strnlen_s</name><argument_list>(<argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>snprintf</name><argument_list>(<argument><expr><name>http_hdr</name> <operator>+</operator> <name>hdrlen</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>, <argument><expr><literal type="string">"%s: %s%s"</literal></expr></argument>, <argument><expr><name>EST_HTTP_HDR_CE</name></expr></argument>,
                 <argument><expr><name>EST_HTTP_CE_BASE64</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><name>hdrlen</name> <operator>=</operator> <call><name>strnlen_s</name><argument_list>(<argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>snprintf</name><argument_list>(<argument><expr><name>http_hdr</name> <operator>+</operator> <name>hdrlen</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>, <argument><expr><literal type="string">"%s: %d%s%s"</literal></expr></argument>, <argument><expr><name>EST_HTTP_HDR_CL</name></expr></argument>,
                 <argument><expr><name>cert_len</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_EOL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if>if <condition>(<expr><operator>!</operator><call><name>mg_write</name><argument_list>(<argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><call><name>strnlen_s</name><argument_list>(<argument><expr><name>http_hdr</name></expr></argument>, <argument><expr><name>EST_HTTP_HDR_MAX</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><call><name>X509_REQ_free</name><argument_list>(<argument><expr><name>csr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>EST_ERR_HTTP_WRITE</name><operator>)</operator></expr>;</return>
        }</block></then></if>

        <comment type="block">/*
         * Send the signed PKCS7 certificate in the body
         */</comment>
        <if>if <condition>(<expr><operator>!</operator><call><name>mg_write</name><argument_list>(<argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>cert</name></expr></argument>, <argument><expr><name>cert_len</name></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><call><name>X509_REQ_free</name><argument_list>(<argument><expr><name>csr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>EST_ERR_HTTP_WRITE</name><operator>)</operator></expr>;</return>
        }</block></then></if>
        <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>cert</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></then> <elseif>else <if>if <condition>(<expr><name>rv</name> <operator>==</operator> <name>EST_ERR_CA_ENROLL_RETRY</name></expr>)</condition><then> <block>{
        <comment type="block">/*
         * The CA did not sign the request and has asked the
         * client to retry in the future.  This may occur if
         * the CA is not configured for automatic enrollment.
         * Send the HTTP retry response to the client.
         */</comment>
        <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"CA server requests retry, possibly it's not setup for auto-enroll"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><name>EST_ERR_NONE</name> <operator>!=</operator> <call><name>est_server_send_http_retry_after</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>retry_period</name></name></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{ 
	    <expr_stmt><expr><call><name>X509_REQ_free</name><argument_list>(<argument><expr><name>csr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>EST_ERR_HTTP_WRITE</name><operator>)</operator></expr>;</return>
	}</block></then></if>
    }</block></then></if></elseif> <else>else <block>{
	<expr_stmt><expr><call><name>X509_REQ_free</name><argument_list>(<argument><expr><name>csr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_CA_ENROLL_FAIL</name><operator>)</operator></expr>;</return>
    }</block></else></if>

    <expr_stmt><expr><call><name>X509_REQ_free</name><argument_list>(<argument><expr><name>csr</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*
 * This function is used by the server to process an incoming
 * csr attributes request from the client.
 */</comment>
<function><specifier>static</specifier> <type><name>int</name></type> <name>est_handle_csr_attrs</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>void</name> <modifier>*</modifier></type><name>http_ctx</name></decl></parameter>, <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>path_seg</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>int</name></type> <name>rv</name> <init>= <expr><name>EST_ERR_NONE</name></expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>pop_present</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>char</name> <modifier>*</modifier></type><name>csr_data</name></decl>, <modifier>*</modifier><decl><type ref="prev"/><name>csr_data_pop</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>csr_len</name></decl>, <decl><type ref="prev"/><name>csr_pop_len</name></decl>;</decl_stmt>

    <if>if <condition>(<expr><operator>!</operator><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs</name></name> <operator>&amp;&amp;</operator> <operator>!</operator><name><name>ctx</name><operator>-&gt;</operator><name>est_get_csr_cb</name></name></expr>)</condition><then> <block>{
        <if>if <condition>(<expr><operator>!</operator><name><name>ctx</name><operator>-&gt;</operator><name>server_enable_pop</name></name></expr>)</condition><then> <block>{
  	        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null csr callback"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<comment type="block">/* Send a 204 response indicating the server doesn't have a CSR */</comment>
		<expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_HTTP_NO_CONTENT</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
        }</block></then> <else>else <block>{
	  <expr_stmt><expr><name>csr_data</name> <operator>=</operator> <call><name>malloc</name><argument_list>(<argument><expr><name>EST_CSRATTRS_POP_LEN</name> <operator>+</operator> <literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <if>if <condition>(<expr><operator>!</operator><name>csr_data</name></expr>)</condition><then> <block>{
                <return>return <expr><operator>(</operator><name>EST_ERR_MALLOC</name><operator>)</operator></expr>;</return>
	    }</block></then></if>
	    <expr_stmt><expr><call><name>strncpy_s</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>, <argument><expr><name>EST_CSRATTRS_POP_LEN</name> <operator>+</operator> <literal type="number">1</literal></expr></argument>, <argument><expr><name>EST_CSRATTRS_POP</name></expr></argument>, 
		      <argument><expr><name>EST_CSRATTRS_POP_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <expr_stmt><expr><name><name>csr_data</name><index>[<expr><name>EST_CSRATTRS_POP_LEN</name></expr>]</index></name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
	    <expr_stmt><expr><name>csr_len</name> <operator>=</operator> <name>EST_CSRATTRS_POP_LEN</name></expr>;</expr_stmt>
	    <return>return <expr><operator>(</operator><call><name>est_send_csrattr_data</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>csr_data</name></expr></argument>, <argument><expr><name>csr_len</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>)</argument_list></call><operator>)</operator></expr>;</return>
        }</block></else></if>
    }</block></then></if>

    <comment type="block">/*
     * Invoke CA server callback to retrieve the CSR.  Callback takes priority
     * over saved values in the context.
     * Note: there is no need to authenticate the client (see sec 4.5)
     */</comment>
    <if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>est_get_csr_cb</name></name></expr>)</condition><then> <block>{
	<expr_stmt><expr><name>csr_data</name> <operator>=</operator> <operator>(</operator><name>char</name> <operator>*</operator><operator>)</operator><call><name><name>ctx</name><operator>-&gt;</operator><name>est_get_csr_cb</name></name><argument_list>(<argument><expr><operator>&amp;</operator><name>csr_len</name></expr></argument>, <argument><expr><name>path_seg</name></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>ex_data</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name>est_asn1_parse_attributes</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>, <argument><expr><name>csr_len</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>pop_present</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><name>csr_len</name> <operator>&amp;&amp;</operator> <operator>(</operator><name>rv</name> <operator>!=</operator> <name>EST_ERR_NONE</name><operator>)</operator></expr>)</condition><then> <block>{
            <if>if <condition>(<expr><name>csr_data</name></expr>)</condition><then> <block>{
                <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            }</block></then></if>
	    <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_HTTP_NO_CONTENT</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
	}</block></then></if>

	<expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>csr_pop_present</name></name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
	<if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>server_enable_pop</name></name></expr>)</condition><then> <block>{
	    <expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name>est_is_challengePassword_present</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>, <argument><expr><name>csr_len</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>pop_present</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <if>if <condition>(<expr><name>rv</name> <operator>!=</operator> <name>EST_ERR_NONE</name></expr>)</condition><then> <block>{
		<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Error during PoP/sanity check"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<if>if <condition>(<expr><name>csr_data</name></expr>)</condition><then> <block>{
		    <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		}</block></then></if>
		<expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_HTTP_NO_CONTENT</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
	    }</block></then></if>
	    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>csr_pop_present</name></name> <operator>=</operator> <name>pop_present</name></expr>;</expr_stmt>

	    <if>if <condition>(<expr><operator>!</operator><name><name>ctx</name><operator>-&gt;</operator><name>csr_pop_present</name></name></expr>)</condition><then> <block>{
		<if>if <condition>(<expr><name>csr_len</name> <operator>==</operator> <literal type="number">0</literal></expr>)</condition><then> <block>{
                    <expr_stmt><expr><name>csr_data</name> <operator>=</operator> <call><name>malloc</name><argument_list>(<argument><expr><name>EST_CSRATTRS_POP_LEN</name> <operator>+</operator> <literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		    <if>if <condition>(<expr><operator>!</operator><name>csr_data</name></expr>)</condition><then> <block>{
			<return>return <expr><operator>(</operator><name>EST_ERR_MALLOC</name><operator>)</operator></expr>;</return>
		    }</block></then></if>
		    <expr_stmt><expr><call><name>strncpy_s</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>, <argument><expr><name>EST_CSRATTRS_POP_LEN</name> <operator>+</operator> <literal type="number">1</literal></expr></argument>, 
			      <argument><expr><name>EST_CSRATTRS_POP</name></expr></argument>, <argument><expr><name>EST_CSRATTRS_POP_LEN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		    <expr_stmt><expr><name><name>csr_data</name><index>[<expr><name>EST_CSRATTRS_POP_LEN</name></expr>]</index></name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
		    <expr_stmt><expr><name>csr_len</name> <operator>=</operator> <name>EST_CSRATTRS_POP_LEN</name></expr>;</expr_stmt>
		    <return>return <expr><operator>(</operator><call><name>est_send_csrattr_data</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>csr_data</name></expr></argument>, <argument><expr><name>csr_len</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>)</argument_list></call><operator>)</operator></expr>;</return>
		}</block></then></if>
		<expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name>est_add_challengePassword</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>, <argument><expr><name>csr_len</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>csr_data_pop</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>csr_pop_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<if>if <condition>(<expr><name>rv</name> <operator>!=</operator> <name>EST_ERR_NONE</name></expr>)</condition><then> <block>{
		    <if>if <condition>(<expr><name>csr_data</name></expr>)</condition><then> <block>{
		        <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		    }</block></then></if>
		    <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Error during add PoP"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		    <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_HTTP_NO_CONTENT</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
		}</block></then></if>
		<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<expr_stmt><expr><name>csr_data</name> <operator>=</operator> <name>csr_data_pop</name></expr>;</expr_stmt>
		<expr_stmt><expr><name>csr_len</name> <operator>=</operator> <name>csr_pop_len</name></expr>;</expr_stmt>
	    }</block></then></if>
	}</block></then></if>
    }</block></then> <else>else <block>{
        <expr_stmt><expr><name>csr_data</name> <operator>=</operator> <call><name>malloc</name><argument_list>(<argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name> <operator>+</operator> <literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><operator>!</operator><name>csr_data</name></expr>)</condition><then> <block>{
            <return>return <expr><operator>(</operator><name>EST_ERR_MALLOC</name><operator>)</operator></expr>;</return>
        }</block></then></if>
        <expr_stmt><expr><call><name>strncpy_s</name><argument_list>(<argument><expr><name>csr_data</name></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name> <operator>+</operator> <literal type="number">1</literal></expr></argument>, 
		  <argument><expr><operator>(</operator><name>char</name> <operator>*</operator><operator>)</operator><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs</name></name></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><name><name>csr_data</name><index>[<expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name></expr>]</index></name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
	<expr_stmt><expr><name>csr_len</name> <operator>=</operator> <name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name></expr>;</expr_stmt>
    }</block></else></if>
    <return>return <expr><operator>(</operator><call><name>est_send_csrattr_data</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>csr_data</name></expr></argument>, <argument><expr><name>csr_len</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>)</argument_list></call><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*
 * This function should be called by the web server layer when
 * a HTTP request arrives on the listening port of the EST server.
 * It will determine the EST request type and dispatch the request
 * to the appropriate handler.
 *
 * Paramters:
 *      ctx:	    Pointer to EST_CTX
 *      http_ctx:   Context pointer from web server
 *      method:     The HTML method in the request, should be either "GET" or "POST"
 *	uri:	    pointer to HTTP URI
 *	body:	    pointer to full HTML body contents
 *	body_len:   length of HTML body
 *	ct:         HTML content type header
 */</comment>
<function><type><name>int</name></type> <name>est_http_request</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>void</name> <modifier>*</modifier></type><name>http_ctx</name></decl></parameter>,
                      <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>method</name></decl></parameter>, <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>uri</name></decl></parameter>,
                      <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>body</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>body_len</name></decl></parameter>, <parameter><decl><type><specifier>const</specifier> <name>char</name> <modifier>*</modifier></type><name>ct</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>SSL</name> <modifier>*</modifier></type><name>ssl</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>rc</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>EST_OPERATION</name></type> <name>operation</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>char</name> <modifier>*</modifier></type><name>path_seg</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>EST_ERROR</name></type> <name>rv</name> <init>= <expr><name>EST_ERR_NONE</name></expr></init></decl>;</decl_stmt>
    
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Verify the context is for a server, not a client
     */</comment>
    <if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>est_mode</name></name> <operator>!=</operator> <name>EST_SERVER</name></expr>)</condition><then> <block>{
        <return>return <expr><operator>(</operator><name>EST_ERR_BAD_MODE</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name>est_parse_uri</name><argument_list>(<argument><expr><name>uri</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>operation</name></expr></argument>, <argument><expr><operator>(</operator><name>char</name> <operator>*</operator><operator>*</operator><operator>)</operator><operator>&amp;</operator><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><name>rv</name> <operator>!=</operator> <name>EST_ERR_NONE</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>rv</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>rv</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * See if this is a cacerts request
     */</comment>
    <if>if <condition>(<expr><name>operation</name> <operator>==</operator> <name>EST_OP_CACERTS</name></expr>)</condition><then> <block>{
        <comment type="block">/* Only GET is allowed */</comment>
        <if>if <condition>(<expr><call><name>strncmp</name><argument_list>(<argument><expr><name>method</name></expr></argument>, <argument><expr><literal type="string">"GET"</literal></expr></argument>, <argument><expr><literal type="number">3</literal></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_WRONG_METHOD</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>path_seg</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>EST_ERR_WRONG_METHOD</name><operator>)</operator></expr>;</return>
        }</block></then></if>

        <comment type="block">/* rc = est_handle_cacerts(ctx, ctx-&gt;ca_certs, ctx-&gt;ca_certs_len, */</comment>
        <comment type="block">/*                         http_ctx, path_seg); */</comment>
        <expr_stmt><expr><name>rc</name> <operator>=</operator> <call><name>est_server_handle_cacerts</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <comment type="block">/* rc = est_server_handle_cacerts(ctx, http_ctx, path_seg); */</comment>
        <if>if <condition>(<expr><name>rc</name> <operator>!=</operator> <name>EST_ERR_NONE</name></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>rc</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>path_seg</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>rc</name><operator>)</operator></expr>;</return>
        }</block></then></if>
    }</block></then>

    <comment type="block">/*
     * See if this is a simple enrollment request
     */</comment>
    <elseif>else <if>if <condition>(<expr><name>operation</name> <operator>==</operator> <name>EST_OP_SIMPLE_ENROLL</name></expr>)</condition><then> <block>{
        <comment type="block">/* Only POST is allowed */</comment>
        <if>if <condition>(<expr><call><name>strncmp</name><argument_list>(<argument><expr><name>method</name></expr></argument>, <argument><expr><literal type="string">"POST"</literal></expr></argument>, <argument><expr><literal type="number">4</literal></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"Incoming HTTP request used wrong method\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_WRONG_METHOD</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>path_seg</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>EST_ERR_WRONG_METHOD</name><operator>)</operator></expr>;</return>
        }</block></then></if>
	<if>if <condition>(<expr><operator>!</operator><name>ct</name></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"Incoming HTTP header has no Content-Type header\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_BAD_PKCS10</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>path_seg</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
	    <return>return <expr><operator>(</operator><name>EST_ERR_BAD_CONTENT_TYPE</name><operator>)</operator></expr>;</return> 
	}</block></then></if>
        <comment type="block">/*
         * Get the SSL context, which is required for authenticating
         * the client.
         */</comment>
        <expr_stmt><expr><name>ssl</name> <operator>=</operator> <operator>(</operator><name>SSL</name><operator>*</operator><operator>)</operator><call><name>mg_get_conn_ssl</name><argument_list>(<argument><expr><name>http_ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if>if <condition>(<expr><operator>!</operator><name>ssl</name></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_NO_SSL_CTX</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>path_seg</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>EST_ERR_NO_SSL_CTX</name><operator>)</operator></expr>;</return>
        }</block></then></if>

        <expr_stmt><expr><name>rc</name> <operator>=</operator> <call><name>est_handle_simple_enroll</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>ssl</name></expr></argument>, <argument><expr><name>ct</name></expr></argument>, <argument><expr><name>body</name></expr></argument>, <argument><expr><name>body_len</name></expr></argument>,
                                      <argument><expr><name>path_seg</name></expr></argument>, <argument><expr><literal type="number">0</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if>if <condition>(<expr><name>rc</name> <operator>!=</operator> <name>EST_ERR_NONE</name> <operator>&amp;&amp;</operator> <name>rc</name> <operator>!=</operator> <name>EST_ERR_AUTH_PENDING</name></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"Enrollment failed with rc=%d (%s)\n"</literal></expr></argument>, 
		         <argument><expr><name>rc</name></expr></argument>, <argument><expr><call><name>EST_ERR_NUM_TO_STR</name><argument_list>(<argument><expr><name>rc</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <if>if <condition>(<expr><name>rc</name> <operator>==</operator> <name>EST_ERR_AUTH_FAIL</name></expr>)</condition><then> <block>{
		<expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_AUTH_FAIL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    }</block></then> <else>else <block>{
		<expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_BAD_PKCS10</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    }</block></else></if>
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>path_seg</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
            <return>return <expr><name>rc</name></expr>;</return>
        }</block></then></if>
    }</block></then></if></elseif>

    <comment type="block">/*
     * See if this is a re-enrollment request
     */</comment>
    <elseif>else <if>if <condition>(<expr><name>operation</name> <operator>==</operator> <name>EST_OP_SIMPLE_REENROLL</name></expr>)</condition><then> <block>{
        <comment type="block">/* Only POST is allowed */</comment>
        <if>if <condition>(<expr><call><name>strncmp</name><argument_list>(<argument><expr><name>method</name></expr></argument>, <argument><expr><literal type="string">"POST"</literal></expr></argument>, <argument><expr><literal type="number">4</literal></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"Incoming HTTP request used wrong method\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_WRONG_METHOD</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>path_seg</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>EST_ERR_WRONG_METHOD</name><operator>)</operator></expr>;</return>
        }</block></then></if>
	<if>if <condition>(<expr><operator>!</operator><name>ct</name></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"Incoming HTTP header has no Content-Type header\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_BAD_PKCS10</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>path_seg</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
	    <return>return <expr><operator>(</operator><name>EST_ERR_BAD_CONTENT_TYPE</name><operator>)</operator></expr>;</return> 
	}</block></then></if>
        <comment type="block">/*
         * Get the SSL context, which is required for authenticating
         * the client.
         */</comment>
        <expr_stmt><expr><name>ssl</name> <operator>=</operator> <operator>(</operator><name>SSL</name><operator>*</operator><operator>)</operator><call><name>mg_get_conn_ssl</name><argument_list>(<argument><expr><name>http_ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if>if <condition>(<expr><operator>!</operator><name>ssl</name></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_NO_SSL_CTX</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>path_seg</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>EST_ERR_NO_SSL_CTX</name><operator>)</operator></expr>;</return>
        }</block></then></if>

        <expr_stmt><expr><name>rc</name> <operator>=</operator> <call><name>est_handle_simple_enroll</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>ssl</name></expr></argument>, <argument><expr><name>ct</name></expr></argument>, <argument><expr><name>body</name></expr></argument>, <argument><expr><name>body_len</name></expr></argument>,
                                      <argument><expr><name>path_seg</name></expr></argument>, <argument><expr><literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if>if <condition>(<expr><name>rc</name> <operator>!=</operator> <name>EST_ERR_NONE</name> <operator>&amp;&amp;</operator> <name>rc</name> <operator>!=</operator> <name>EST_ERR_AUTH_PENDING</name></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"Reenroll failed with rc=%d (%s)\n"</literal></expr></argument>, 
		         <argument><expr><name>rc</name></expr></argument>, <argument><expr><call><name>EST_ERR_NUM_TO_STR</name><argument_list>(<argument><expr><name>rc</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <if>if <condition>(<expr><name>rc</name> <operator>==</operator> <name>EST_ERR_AUTH_FAIL</name></expr>)</condition><then> <block>{
		<expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_AUTH_FAIL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    }</block></then> <else>else <block>{
		<expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_BAD_PKCS10</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    }</block></else></if>
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>path_seg</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>EST_ERR_BAD_PKCS10</name><operator>)</operator></expr>;</return>
        }</block></then></if>
    }</block></then></if></elseif>

<cpp:if>#<cpp:directive>if</cpp:directive> <expr><literal type="number">0</literal></expr></cpp:if>
    <comment type="block">/*
     * See if this is a keygen request
     * FIXME: this is currently not implemented
     */</comment>
    else if (strncmp(uri, EST_KEYGEN_URI, EST_URI_MAX_LEN) == 0) {
        <comment type="block">/* Only POST is allowed */</comment>
        if (strncmp(method, "POST", 4)) {
            EST_LOG_WARN("Incoming HTTP request used wrong method\n");
            est_send_http_error(ctx, http_ctx, EST_ERR_WRONG_METHOD);
            return (EST_ERR_WRONG_METHOD);
        }
	if (!ct) {
            EST_LOG_WARN("Incoming HTTP header has no Content-Type header\n");
	    return (EST_ERR_BAD_CONTENT_TYPE); 
	}
        if (est_handle_keygen(ctx)) {
            est_send_http_error(ctx, http_ctx, 0); <comment type="line">//FIXME: last param should not be zero</comment>
            return (EST_ERR_HTTP_WRITE);           <comment type="line">//FIXME: need the appropriate return code</comment>
        }
    }
<cpp:endif>#<cpp:directive>endif</cpp:directive></cpp:endif>

    <comment type="block">/*
     * See if this is a CSR attributes request
     */</comment>
    <elseif>else <if>if <condition>(<expr><name>operation</name> <operator>==</operator> <name>EST_OP_CSRATTRS</name></expr>)</condition><then> <block>{
        <comment type="block">/* Only GET is allowed */</comment>
        <if>if <condition>(<expr><call><name>strncmp</name><argument_list>(<argument><expr><name>method</name></expr></argument>, <argument><expr><literal type="string">"GET"</literal></expr></argument>, <argument><expr><literal type="number">4</literal></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"Incoming HTTP request used wrong method\n"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_WRONG_METHOD</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>path_seg</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>EST_ERR_WRONG_METHOD</name><operator>)</operator></expr>;</return>
        }</block></then></if>

        <expr_stmt><expr><name>rc</name> <operator>=</operator> <call><name>est_handle_csr_attrs</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><name>rc</name> <operator>!=</operator> <name>EST_ERR_NONE</name></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>rc</name></expr></argument>)</argument_list></call></expr>;</expr_stmt> 
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><name>path_seg</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
            <return>return <expr><operator>(</operator><name>rc</name><operator>)</operator></expr>;</return>
        }</block></then></if>
    }</block></then></if></elseif>

    <comment type="block">/*
     * Send a 404 error if the URI didn't match 
     */</comment>
    <else>else <block>{
        <expr_stmt><expr><call><name>est_send_http_error</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>http_ctx</name></expr></argument>, <argument><expr><name>EST_ERR_HTTP_NOT_FOUND</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></else></if>
    
    <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>path_seg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><name>path_seg</name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>


<comment type="block">/*! @brief est_server_start() is used by an application to start
    the EST server after est_server_init() has been called and
    all the required callback functions have been provided by
    the application.   
 
    @param ctx Pointer to the EST context

    libEST uses HTTP code from the Mongoose HTTP server.
    This function allows the application to start the HTTP
    services layer, which is required by EST.
 
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_start</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>EST_MG_CONTEXT</name> <modifier>*</modifier></type><name>mgctx</name></decl>;</decl_stmt>

    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name>mgctx</name> <operator>=</operator> <call><name>mg_start</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><name>mgctx</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>mg_ctx</name></name> <operator>=</operator> <name>mgctx</name></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
    }</block></then> <else>else <block>{
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_SSL_CTX</name><operator>)</operator></expr>;</return>
    }</block></else></if>
}</block></function>

<comment type="block">/*! @brief est_server_stop() is used by an application to stop
    the EST server.  This should be called prior to est_destroy().
 
    @param ctx Pointer to the EST context

    libEST uses HTTP code from the Mongoose HTTP server.
    This function allows the application to stop the HTTP
    services layer.
 
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_stop</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>EST_MG_CONTEXT</name> <modifier>*</modifier></type><name>mgctx</name></decl>;</decl_stmt>

    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name>mgctx</name> <operator>=</operator> <operator>(</operator><name>EST_MG_CONTEXT</name><operator>*</operator><operator>)</operator><name><name>ctx</name><operator>-&gt;</operator><name>mg_ctx</name></name></expr>;</expr_stmt>
    <if>if <condition>(<expr><name>mgctx</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>mg_stop</name><argument_list>(<argument><expr><name>mgctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></then></if>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*! @brief est_server_init() is used by an application to create
    a context in the EST library when operating as an EST server that
    fronts a CA.  This context is used when invoking other functions in the API.
 
    @param ca_chain     Char array containing PEM encoded CA certs &amp; CRL entries 
    @param ca_chain_len Length of ca_chain char array 
    @param cacerts_resp_chain Char array containing PEM encoded CA certs to include
                              in the /cacerts response
    @param cacerts_resp_chain_len Length of cacerts_resp_chain char array
    @param cert_format Specifies the encoding of the local and external
                       certificate chains (PEM/DER).  
    @param http_realm Char array containing HTTP realm name for HTTP auth
    @param tls_id_cert Pointer to X509 that contains the server's certificate
                    for the TLS layer.
    @param tls_id_key Pointer to EVP_PKEY that contains the private key
                   associated with the server's certificate.

    This function allows an application to initialize an EST server context
    that is used with a CA (not an RA).
    The application must provide the trusted CA certificates to use
    for server operation using the ca_chain parameter.  This certificate
    set should include the explicit trust anchor certificate, any number
    of implicit trust anchor certificates, and any intermediate sub-CA
    certificates required to complete the chain of trust between the
    identity certificate passed into the tls_id_cert parameter and the
    root certificate for that identity certificate.  
    The CA certificates should be encoded using
    the format specified in the cert_format parameter (e.g. PEM) and
    may contain CRL entries that will be used when authenticating
    EST clients connecting to the server.  
    The applications must also provide the HTTP realm to use for 
    HTTP authentication and the server cerificate/private key to use
    for the TLS stack to identify the server.
    
    Warning: Including additional intermediate sub-CA certificates that are
             not needed to complete the chain of trust may result in a
	     potential MITM attack.  
 
    @return EST_CTX.
 */</comment>
<function><type><name>EST_CTX</name> <modifier>*</modifier></type> <name>est_server_init</name> <parameter_list>(<parameter><decl><type><name>unsigned</name> <name>char</name> <modifier>*</modifier></type><name>ca_chain</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>ca_chain_len</name></decl></parameter>,
                           <parameter><decl><type><name>unsigned</name> <name>char</name> <modifier>*</modifier></type><name>cacerts_resp_chain</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>cacerts_resp_chain_len</name></decl></parameter>,
			   <parameter><decl><type><name>EST_CERT_FORMAT</name></type> <name>cert_format</name></decl></parameter>,
                           <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>http_realm</name></decl></parameter>, 
			   <parameter><decl><type><name>X509</name> <modifier>*</modifier></type><name>tls_id_cert</name></decl></parameter>, <parameter><decl><type><name>EVP_PKEY</name> <modifier>*</modifier></type><name>tls_id_key</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>len</name></decl>;</decl_stmt>

    <expr_stmt><expr><call><name>est_log_version</name><argument_list>()</argument_list></call></expr>;</expr_stmt>

    <comment type="block">/*
     * Sanity check the input
     */</comment>
    <if>if <condition>(<expr><name>ca_chain</name> <operator>==</operator> <name>NULL</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Trusted CA certificate set is empty"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><name>NULL</name></expr>;</return>
    }</block></then></if>
    <if>if <condition>(<expr><name>cert_format</name> <operator>!=</operator> <name>EST_CERT_FORMAT_PEM</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Only PEM encoding of certificate changes is supported."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><name>NULL</name></expr>;</return>
    }</block></then></if>

    <comment type="block">/* 
     * Check the length value, it should match.
     */</comment>
    <expr_stmt><expr><name>len</name> <operator>=</operator> <operator>(</operator><name>int</name><operator>)</operator> <call><name>strnlen_s</name><argument_list>(<argument><expr><operator>(</operator><name>char</name> <operator>*</operator><operator>)</operator><name>ca_chain</name></expr></argument>, <argument><expr><name>EST_CA_MAX</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><name>len</name> <operator>!=</operator> <name>ca_chain_len</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Length of ca_chain doesn't match ca_chain_len"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><name>NULL</name></expr>;</return>
    }</block></then></if>
    <if>if <condition>(<expr><name>cacerts_resp_chain</name></expr>)</condition><then> <block>{        
        <expr_stmt><expr><name>len</name> <operator>=</operator> <operator>(</operator><name>int</name><operator>)</operator> <call><name>strnlen_s</name><argument_list>(<argument><expr><operator>(</operator><name>char</name> <operator>*</operator><operator>)</operator><name>cacerts_resp_chain</name></expr></argument>, <argument><expr><name>EST_CA_MAX</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if>if <condition>(<expr><name>len</name> <operator>!=</operator> <name>cacerts_resp_chain_len</name></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Actual length of cacerts_resp_chain does not match "</literal>
                        <literal type="string">"passed in length value"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return>return <expr><name>NULL</name></expr>;</return>
        }</block></then></if>
    }</block></then></if>

    <if>if <condition>(<expr><name>tls_id_cert</name> <operator>==</operator> <name>NULL</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"TLS identity cert is empty"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><name>NULL</name></expr>;</return>
    }</block></then></if>

    <if>if <condition>(<expr><name>tls_id_key</name> <operator>==</operator> <name>NULL</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Private key associated with TLS identity cert is empty"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><name>NULL</name></expr>;</return>
    }</block></then></if>
    <if>if <condition>(<expr><name>http_realm</name> <operator>==</operator> <name>NULL</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"EST HTTP realm is NULL"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><name>NULL</name></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name>ctx</name> <operator>=</operator> <call><name>malloc</name><argument_list>(<argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name>EST_CTX</name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"malloc failed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><name>NULL</name></expr>;</return>
    }</block></then></if>
    <expr_stmt><expr><call><name>memzero_s</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name>EST_CTX</name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>est_mode</name></name> <operator>=</operator> <name>EST_SERVER</name></expr>;</expr_stmt>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>retry_period</name></name> <operator>=</operator> <name>EST_RETRY_PERIOD_DEF</name></expr>;</expr_stmt>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>require_http_auth</name></name> <operator>=</operator> <name>HTTP_AUTH_REQUIRED</name></expr>;</expr_stmt>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_read_timeout</name></name> <operator>=</operator> <name>EST_SSL_READ_TIMEOUT_DEF</name></expr>;</expr_stmt>

    <comment type="block">/*
     * Load the CA certificates into local memory and retain
     * for future use.  This will be used for /cacerts requests.
     * They are optional parameters.  The alternative is for the
     * app layer to provide callback and return them on the fly.
     */</comment>
    <if>if <condition>(<expr><name>cacerts_resp_chain</name></expr>)</condition><then> 
    <block>{   
        <if>if <condition>(<expr><call><name>est_load_ca_certs</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>cacerts_resp_chain</name></expr></argument>, <argument><expr><name>cacerts_resp_chain_len</name></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Failed to load CA certificates response buffer"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            <return>return <expr><name>NULL</name></expr>;</return>
        }</block></then></if>
    }</block></then></if>
    <if>if <condition>(<expr><call><name>est_load_trusted_certs</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>, <argument><expr><name>ca_chain</name></expr></argument>, <argument><expr><name>ca_chain_len</name></expr></argument>)</argument_list></call></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Failed to load trusted certficate store"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><name>NULL</name></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><call><name>strncpy_s</name><argument_list>(<argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>realm</name></name></expr></argument>, <argument><expr><name>MAX_REALM</name></expr></argument>, <argument><expr><name>http_realm</name></expr></argument>, <argument><expr><name>MAX_REALM</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_cert</name></name> <operator>=</operator> <name>tls_id_cert</name></expr>;</expr_stmt>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_priv_key</name></name> <operator>=</operator> <name>tls_id_key</name></expr>;</expr_stmt>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>auth_mode</name></name> <operator>=</operator> <name>AUTH_BASIC</name></expr>;</expr_stmt>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_enable_pop</name></name> <operator>=</operator> <literal type="number">1</literal></expr>;</expr_stmt>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>local_cacerts_processing</name></name> <operator>=</operator> <literal type="number">1</literal></expr>;</expr_stmt>

    <comment type="block">/* 
     * Create a new ASN object for the id-kp-cmcRA OID.  
     * OpenSSL doesn't define this, so we need to create it
     * ourselves.
     * http://www.openssl.org/docs/crypto/OBJ_nid2obj.html
     */</comment>
    <if>if <condition>(<expr><operator>!</operator><name>o_cmcRA</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><name>o_cmcRA</name> <operator>=</operator> <call><name>OBJ_txt2obj</name><argument_list>(<argument><expr><literal type="string">"1.3.6.1.5.5.7.3.28"</literal></expr></argument>, <argument><expr><literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><operator>!</operator><name>o_cmcRA</name></expr>)</condition><then> <block>{
	    <expr_stmt><expr><call><name>EST_LOG_WARN</name><argument_list>(<argument><expr><literal type="string">"Failed to create OID for id-kp-cmcRA key usage checks"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	}</block></then></if>
    }</block></then></if>

    <return>return <expr><operator>(</operator><name>ctx</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*! @brief est_server_set_auth_mode() is used by an application to configure
    the HTTP authentication method to use for validating the identity of
    an EST client.
 
    @param ctx   Pointer to the EST context
    @param amode Must be one of the following: AUTH_BASIC, AUTH_DIGEST, AUTH_TOKEN

    This function can optionally be invoked by the application to change the
    default HTTP authentication mode.  The default mode is HTTP Basic
    authentication.  An application may desire to use Digest or Token
    authentication instead, in which case this function can be used to set
    that mode.  This function must be invoked prior to starting the EST
    server.

    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_set_auth_mode</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>EST_HTTP_AUTH_MODE</name></type> <name>amode</name></decl></parameter>)</parameter_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <switch>switch <condition>(<expr><name>amode</name></expr>)</condition> <block>{
    <case>case <expr><name>AUTH_DIGEST</name></expr>:</case>
        <comment type="block">/*
         * Since HTTP digest auth uses MD5, make sure we're not in FIPS mode.
         */</comment>
	<if>if <condition>(<expr><call><name>FIPS_mode</name><argument_list>()</argument_list></call></expr>)</condition><then> <block>{
	    <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"HTTP digest auth not allowed while in FIPS mode"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <return>return <expr><operator>(</operator><name>EST_ERR_BAD_MODE</name><operator>)</operator></expr>;</return>
	}</block></then></if>
        <comment type="block">/* fallthrough */</comment>
    <case>case <expr><name>AUTH_BASIC</name></expr>:</case>        
    <case>case <expr><name>AUTH_TOKEN</name></expr>:</case>        
	<expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>auth_mode</name></name> <operator>=</operator> <name>amode</name></expr>;</expr_stmt>
	<return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
	<break>break;</break>
    <default>default:</default>
        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Unsupported HTTP authentication mode, only Basic, Digest and Token allowed"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<return>return <expr><operator>(</operator><name>EST_ERR_BAD_MODE</name><operator>)</operator></expr>;</return>
	<break>break;</break>
    }</block></switch>
}</block></function>

<comment type="block">/*! @brief est_set_ca_enroll_cb() is used by an application to install
    a handler for signing incoming PKCS10 requests.  
 
    @param ctx Pointer to the EST context
    @param cb Function address of the handler

    This function must be called prior to starting the EST server.  The
    callback function must match the following prototype:

        int func(unsigned char*, int, unsigned char**, int*, char*, X509*, char *, void *);

    This function is called by libEST when a certificate request
    needs to be signed by the CA server.  The application will need
    to forward the request to the signing authority and return
    the response.  The response should be a PKCS7 signed certificate.
 
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_set_ca_enroll_cb</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><function_decl><type><name>int</name></type> (<modifier>*</modifier><name>cb</name>)<parameter_list>(<parameter><decl><type><name>unsigned</name> <name>char</name> <modifier>*</modifier></type><name>pkcs10</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>p10_len</name></decl></parameter>,
                                                        <parameter><decl><type><name>unsigned</name> <name>char</name> <modifier>*</modifier><modifier>*</modifier></type><name>pkcs7</name></decl></parameter>, <parameter><decl><type><name>int</name> <modifier>*</modifier></type><name>pkcs7_len</name></decl></parameter>,
                                                        <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>user_id</name></decl></parameter>, <parameter><decl><type><name>X509</name> <modifier>*</modifier></type><name>peer_cert</name></decl></parameter>,
                                                        <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>path_seg</name></decl></parameter>, <parameter><decl><type><name>void</name> <modifier>*</modifier></type><name>ex_data</name></decl></parameter>)</parameter_list></function_decl></parameter>)</parameter_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>est_enroll_pkcs10_cb</name></name> <operator>=</operator> <name>cb</name></expr>;</expr_stmt>

    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*! @brief est_set_ca_reenroll_cb() is used by an application to install
    a handler for re-enrolling certificates.  
 
    @param ctx Pointer to the EST context
    @param cb Function address of the handler

    This function must be called prior to starting the EST server.  The
    callback function must match the following prototype:

        int func(unsigned char*, int, unsigned char**, int*, char*, X509*)

    This function is called by libEST when a certificate 
    needs to be renewed by the CA server.  The application will need
    to forward the request to the signing authority and return
    the response.  The response should be a PKCS7 signed certificate.
 
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_set_ca_reenroll_cb</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><function_decl><type><name>int</name></type> (<modifier>*</modifier><name>cb</name>)<parameter_list>(<parameter><decl><type><name>unsigned</name> <name>char</name> <modifier>*</modifier></type><name>pkcs10</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>p10_len</name></decl></parameter>,
                                                          <parameter><decl><type><name>unsigned</name> <name>char</name> <modifier>*</modifier><modifier>*</modifier></type><name>pkcs7</name></decl></parameter>, <parameter><decl><type><name>int</name> <modifier>*</modifier></type><name>pkcs7_len</name></decl></parameter>,
                                                          <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>user_id</name></decl></parameter>, <parameter><decl><type><name>X509</name> <modifier>*</modifier></type><name>peer_cert</name></decl></parameter>,
                                                          <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>path_seg</name></decl></parameter>, <parameter><decl><type><name>void</name> <modifier>*</modifier></type><name>ex_data</name></decl></parameter>)</parameter_list></function_decl></parameter>)</parameter_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>est_reenroll_pkcs10_cb</name></name> <operator>=</operator> <name>cb</name></expr>;</expr_stmt>

    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*! @brief est_set_csr_cb() is used by an application to install
    a handler for retrieving the CSR attributes from the
    CA server.  
 
    @param ctx Pointer to the EST context
    @param cb Function address of the handler

    This function must be called prior to starting the EST server.  The
    callback function must match the following prototype:

        unsigned char *(*cb)(int*csr_len, char *path_seg, void *ex_data)

    This function is called by libEST when a CSR attributes 
    request is received.  The attributes are provided by the CA
    server and returned as a char array.
 
    @return EST_ERROR.
 */</comment>
<decl_stmt><decl><type><name>EST_ERROR</name></type> <name>est_set_csr_cb</name> <argument_list>(<argument><expr><name>EST_CTX</name> <operator>*</operator><name>ctx</name></expr></argument>, <argument><expr><name>unsigned</name> <name>char</name> <operator>*</operator><call>(<modifier>*</modifier><name>cb</name>)<argument_list>(<argument><expr><name>int</name><operator>*</operator><name>csr_len</name></expr></argument>, <argument><expr><name>char</name> <operator>*</operator><name>path_seg</name></expr></argument>, <argument><expr><name>void</name> <operator>*</operator><name>ex_data</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Verify the context is for a server, not a client or proxy
     */</comment>
    <if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>est_mode</name></name> <operator>!=</operator> <name>EST_SERVER</name></expr>)</condition><then> <block>{
        <return>return <expr><operator>(</operator><name>EST_ERR_BAD_MODE</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>est_get_csr_cb</name></name> <operator>=</operator> <name>cb</name></expr>;</expr_stmt>

    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></decl></decl_stmt>

<comment type="block">/*! @brief est_set_cacerts_cb() is used by an application to install
    a handler for retrieving the CA certs from the CA server.
 
    @param ctx Pointer to the EST context
    @param cb  Function address of the handler

    This function must be called prior to starting the EST server.  The
    callback function must match the following prototype:

        unsigned char *(*cb)(int *csr_len, char *path_seg, void *ex_data)

    This function is called by libEST when a CAcerts request 
    is received.  The CA certs chain is provided by the application 
    layer and returned as a char array.
 
    @return EST_ERROR.
 */</comment>
<decl_stmt><decl><type><name>EST_ERROR</name></type> <name>est_set_cacerts_cb</name> <argument_list>(<argument><expr><name>EST_CTX</name> <operator>*</operator><name>ctx</name></expr></argument>,
              <argument><expr><name>unsigned</name> <name>char</name> <operator>*</operator><call>(<modifier>*</modifier><name>cb</name>)<argument_list>(<argument><expr><name>int</name><operator>*</operator><name>csr_len</name></expr></argument>, <argument><expr><name>char</name> <operator>*</operator><name>path_seg</name></expr></argument>, <argument><expr><name>void</name> <operator>*</operator><name>ex_data</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Verify the context is for a server, not a client or proxy
     */</comment>
    <if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>est_mode</name></name> <operator>!=</operator> <name>EST_SERVER</name></expr>)</condition><then> <block>{
        <return>return <expr><operator>(</operator><name>EST_ERR_BAD_MODE</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>est_get_cacerts_cb</name></name> <operator>=</operator> <name>cb</name></expr>;</expr_stmt>

    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></decl></decl_stmt>

<comment type="block">/*! @brief est_set_http_auth_cb() is used by an application to install
    a handler for authenticating EST clients.
 
    @param ctx Pointer to the EST context
    @param cb Function address of the handler

    This function must be called prior to starting the EST server.  The
    callback function must match the following prototype:

    int (*cb)(EST_CTX *ctx, EST_HTTP_AUTH_HDR *ah, X509 *peer_cert,
              char *path_seg, void *ex_data)

    This function is called by libEST when performing HTTP authentication.
    libEST will pass the EST_HTTP_AUTH_HDR struct to the application,
    allowing the application to hook into a Radius, AAA, or some user
    authentication database.  The X509 certificate from the TLS 
    peer (EST client) is also provided through this callback facility, allowing
    the application layer to check for specific attributes in the 
    X509 certificate such as an 802.1AR device ID.  In addition,
    the path segment string is passed up if there was one in the
    request URI.
 
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_set_http_auth_cb</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, 
                                <parameter><function_decl><type><name>int</name></type> (<modifier>*</modifier><name>cb</name>)<parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>EST_HTTP_AUTH_HDR</name> <modifier>*</modifier></type><name>ah</name></decl></parameter>, 
                                          <parameter><decl><type><name>X509</name> <modifier>*</modifier></type><name>peer_cert</name></decl></parameter>, <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>path_seg</name></decl></parameter>,
					  <parameter><decl><type><name>void</name> <modifier>*</modifier></type><name>ex_data</name></decl></parameter>)</parameter_list></function_decl></parameter>)</parameter_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>est_http_auth_cb</name></name> <operator>=</operator> <name>cb</name></expr>;</expr_stmt>

    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*! @brief est_set_http_auth_required() is used by an application to define whether
    HTTP authentication should be required in addition to using client certificates.
 
    @param ctx Pointer to the EST context
    @param required Flag indicating that HTTP authentication is required. Set 
    to HTTP_AUTH_REQUIRED value to require HTTP auth.  Set to HTTP_AUTH_NOT_REQUIRED 
    if HTTP auth should occur only when TLS client authentication fails.
 
    @return EST_ERROR.

    The default mode is HTTP_AUTH_REQUIRED.  This means that HTTP authentication
    will be attempted even when TLS client authentication succeeds.  If HTTP
    authentication is only needed when TLS client auth fails, then set this
    to HTTP_AUTH_NOT_REQUIRED.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_set_http_auth_required</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>EST_HTTP_AUTH_REQUIRED</name></type> <name>required</name></decl></parameter>)</parameter_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>require_http_auth</name></name> <operator>=</operator> <name>required</name></expr>;</expr_stmt>

    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>


<comment type="block">/*! @brief est_server_enable_srp() is used by an application to enable 
    the TLS-SRP authentication.  This allows EST clients that provide 
    SRP credentials at the TLS layer to be authenticated by the EST
    server.  This function must be invoked to enable server-side
    SRP support. 

    @param ctx Pointer to the EST context
    @param cb Function address of the application specific SRP verifier handler

    This function should be invoked prior to starting the EST server.   
    This is used to specify the handler for SRP authentication at the TLS
    layer.  When a TLS-SRP cipher suite is negotiated at the TLS layer,
    the handler will be invoked by libEST to retrieve the SRP parameters
    for user authentication.  Your application must provide the SRP parameters
    for the user.  
    
    The handler should use the following logic:

    1. Invoke SSL_get_srp_username() to get the SRP user name from the
       TLS layer.
    2. Lookup the user's SRP parameters in the application specific
       user database.  These parameters include the N, g, s, and v 
       parameters.
    3. Invoke SSL_set_srp_server_param() to forward the SRP parameters
       to the TLS layer, allowing the TLS handshake to proceed.
       
    libEST includes an example server application that uses this handler
    for SRP support.  This example uses the OpenSSL SRP verifier file capability
    to manage SRP parameters for individual users.  Your application could use
    this approach, or it may utilize another facility for managing user specific
    SRP parameters.  Please refer to RFC 2945 and RFC 5054 for a full understanding
    of SRP.

    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_enable_srp</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><function_decl><type><name>int</name></type> (<modifier>*</modifier><name>cb</name>)<parameter_list>(<parameter><decl><type><name>SSL</name> <modifier>*</modifier></type><name>s</name></decl></parameter>, <parameter><decl><type><name>int</name> <modifier>*</modifier></type><name>ad</name></decl></parameter>, <parameter><decl><type><name>void</name> <modifier>*</modifier></type><name>arg</name></decl></parameter>)</parameter_list></function_decl></parameter>)</parameter_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <if>if <condition>(<expr><operator>!</operator><name>cb</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null callback"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_INVALID_PARAMETERS</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>est_srp_username_cb</name></name> <operator>=</operator> <name>cb</name></expr>;</expr_stmt>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>enable_srp</name></name> <operator>=</operator> <literal type="number">1</literal></expr>;</expr_stmt>

    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>


<comment type="block">/*! @brief est_server_enable_pop() is used by an application to enable 
    the proof-of-possession check on the EST server.  This proves the 
    EST client that sent the CSR to the server is in possesion of the 
    private key that was used to sign the CSR.  This binds the TLS 
    session ID to the CSR.

    Note, if the CSR attributes configured on the server require PoP 
    checking, then there is no need to call this function to enable
    PoP.  The PoP will be enabled automatically under this scenario.
    
    Note, PoP checking is not possible when an EST proxy is used to
    between the EST client and EST server.  Since the proxy will not 
    be in possession of the private key, an EST server woul fail the
    PoP check.  However, an EST proxy can enable this feature to ensure 
    the EST client has the signing key.

    @param ctx Pointer to the EST context

    This function may be called at any time.   
 
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_enable_pop</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>)</parameter_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_enable_pop</name></name> <operator>=</operator> <literal type="number">1</literal></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*! @brief est_server_disable_pop() is used by an application to disable 
    the proof-of-possession check on the EST server.  Please see
    the documenation for est_server_enable_pop() for more information
    on the proof-of-possession check.

    @param ctx Pointer to the EST context

    This function may be called at any time.   
 
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_disable_pop</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>)</parameter_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_enable_pop</name></name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*! @brief est_server_set_retry_period() is used by an application to  
    change the default retry-after period sent to the EST client when
    the CA server is not configured for auto-enroll.  This retry-after
    value notifies the client about how long it should wait before
    attempting the enroll operation again to see if the CA has 
    approved the original CSR. 
 
    @param ctx Pointer to the EST context
    @param seconds Number of seconds the server will use in the
           retry-after response.

    This function may be called at any time after a context has
    been created.   
 
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_set_retry_period</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>seconds</name></decl></parameter>)</parameter_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <if>if <condition>(<expr><name>seconds</name> <operator>&gt;</operator> <name>EST_RETRY_PERIOD_MAX</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Maximum retry-after period is %d seconds"</literal></expr></argument>,
		<argument><expr><name>EST_RETRY_PERIOD_MAX</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_INVALID_PARAMETERS</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <if>if <condition>(<expr><name>seconds</name> <operator>&lt;</operator> <name>EST_RETRY_PERIOD_MIN</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Minimum retry-after period is %d seconds"</literal></expr></argument>,
		<argument><expr><name>EST_RETRY_PERIOD_MIN</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_INVALID_PARAMETERS</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>retry_period</name></name> <operator>=</operator> <name>seconds</name></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*! @brief est_server_set_ecdhe_curve() is used by an application to 
    specify the ECC curve that should be used for ephemeral diffie-hellman
    keys during the TLS handshake.  Ephemeral diffie-hellman is enabled
    by libEST and provides better forward secrecy.  If the curve
    is not specified by the application using this function, then
    the prime256v1 curve is used as the default curve.  
 
    @param ctx Pointer to the EST context
    @param nid OpenSSL NID value for the desired curve

    This function must be called prior to starting the EST server.  
    The NID values are defined in &lt;openssl/obj_mac.h&gt;.  Typical NID 
    values provided to this function would include:
	
	NID_X9_62_prime192v1
	NID_X9_62_prime256v1
	NID_secp384r1
	NID_secp521r1
 
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_set_ecdhe_curve</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>nid</name></decl></parameter>)</parameter_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>
    <if>if <condition>(<expr><name>nid</name> <operator>&lt;=</operator> <literal type="number">0</literal></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Invalid NID value"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_INVALID_PARAMETERS</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>ecdhe_nid</name></name> <operator>=</operator> <name>nid</name></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*! @brief est_server_set_dh_parms() is used by an application to 
    specify the Diffie-Hellman parameters to be used for single
    use DH key generation during the TLS handshake.  If these 
    parameters are not used, then single-use DH key generation
    is not enabled.  This should be enabled to improve the 
    forward secrecy of the TLS handshake operation.  
    
    The DH parameters provided through this API should not be
    hard-coded in the application.  The parameters should be
    generated at the time of product installation.  Reusing the
    parameters across multiple installations of the product
    results in a vulnerable product.  
 
    @param ctx Pointer to the EST context
    @param parms Pointer to OpenSSL DH parameters

    This function must be called prior to starting the EST server.  
 
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_set_dh_parms</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>DH</name> <modifier>*</modifier></type><name>parms</name></decl></parameter>)</parameter_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>
    <if>if <condition>(<expr><operator>!</operator><name>parms</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null DH parameters"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_INVALID_PARAMETERS</name><operator>)</operator></expr>;</return>
    }</block></then></if>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>dh_tmp</name></name> <operator>=</operator> <call><name>DHparams_dup</name><argument_list>(<argument><expr><name>parms</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*! @brief est_server_init_csrattrs() is used by an application to 
    initialize a fixed set of CSR attributes.  These attributes will
    be used by libEST in response to a client CSR attributes
    request.  The attributes must be an ASN.1 base64 encoded character
    string.

    @param ctx Pointer to the EST context
    @param csrattrs Pointer CSR attributes in ASN.1 base64 encoded format,
                    a NULL pointer clears the attributes and length.
    @param csrattrs_len Length of the CSR attributes character string

    The est_get_csr_cb callback function maintains precendence over this
    method for CSR attributes. If est_get_csr_cb is initialized by the
    application it will be used.  If not, then libEST will use the
    attributes initialized here.

    This function should be called prior to starting the EST server.  
    PoP configuration(est_server_enable_pop or est_server_disable_pop)
    should be called prior to this function.
    
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_init_csrattrs</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>char</name> <modifier>*</modifier></type><name>csrattrs</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>csrattrs_len</name></decl></parameter>)</parameter_list>
<block>{
    <decl_stmt><decl><type><name>int</name></type> <name>csrattrs_pop_len</name></decl>, <decl><type ref="prev"/><name>pop_present</name></decl>, <decl><type ref="prev"/><name>rv</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>char</name> <modifier>*</modifier></type><name>csrattrs_data_pop</name> <init>= <expr><name>NULL</name></expr></init></decl>;</decl_stmt>

    <if>if <condition>(<expr><name>ctx</name> <operator>==</operator> <name>NULL</name></expr>)</condition><then> <block>{
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * Verify the context is for a server, not a client or proxy
     */</comment>
    <if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>est_mode</name></name> <operator>!=</operator> <name>EST_SERVER</name></expr>)</condition><then> <block>{
        <return>return <expr><operator>(</operator><name>EST_ERR_BAD_MODE</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"Attributes pointer is %p, len=%d"</literal></expr></argument>, 
		 <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs</name></name></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

    <comment type="block">/* Free old version if previously initialized */</comment>
    <if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs</name></name> <operator>!=</operator> <name>NULL</name></expr>)</condition><then> <block>{
        <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs</name></name> <operator>=</operator> <name>NULL</name></expr>;</expr_stmt>
        <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
    }</block></then></if>

    <comment type="block">/* caller just wanted to clear it, so return */</comment>
    <if>if <condition>(<expr><name>csrattrs</name> <operator>==</operator> <name>NULL</name></expr>)</condition><then> <block>{
	<return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/*
     * In order to run Client negative unit testing the parameter, 
     * PoP and parse checks all need to be disabled via #define
     * in a couple of places here.
     */</comment>

    <comment type="block">/* 
     * check smallest possible base64 case here for now 
     * and sanity test will check min/max value for ASN.1 data
     */</comment>
    <if>if <condition>(<expr><name>csrattrs_len</name> <operator>&lt;</operator> <name>MIN_CSRATTRS</name></expr>)</condition><then> <block>{
        <return>return <expr><operator>(</operator><name>EST_ERR_INVALID_PARAMETERS</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <comment type="block">/* assume PoP not in CSR attributes */</comment>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>csr_pop_present</name></name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
    <if>if <condition>(<expr><name><name>ctx</name><operator>-&gt;</operator><name>server_enable_pop</name></name></expr>)</condition><then> <block>{
        <expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name>est_is_challengePassword_present</name><argument_list>(<argument><expr><name>csrattrs</name></expr></argument>, <argument><expr><name>csrattrs_len</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>pop_present</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><name>rv</name> <operator>!=</operator> <name>EST_ERR_NONE</name></expr>)</condition><then> <block>{
	    <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Error during PoP/sanity check"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <return>return <expr><operator>(</operator><name>EST_ERR_INVALID_PARAMETERS</name><operator>)</operator></expr>;</return>
	}</block></then></if>
	<expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>csr_pop_present</name></name> <operator>=</operator> <name>pop_present</name></expr>;</expr_stmt>

	<if>if <condition>(<expr><operator>!</operator><name><name>ctx</name><operator>-&gt;</operator><name>csr_pop_present</name></name></expr>)</condition><then> <block>{
	    <expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name>est_add_challengePassword</name><argument_list>(<argument><expr><name>csrattrs</name></expr></argument>, <argument><expr><name>csrattrs_len</name></expr></argument>, 
					   <argument><expr><operator>&amp;</operator><name>csrattrs_data_pop</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>csrattrs_pop_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <if>if <condition>(<expr><name>rv</name> <operator>!=</operator> <name>EST_ERR_NONE</name></expr>)</condition><then> <block>{
		<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Error during add PoP"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<return>return <expr><operator>(</operator><name>EST_ERR_INVALID_PARAMETERS</name><operator>)</operator></expr>;</return>
	    }</block></then></if>
	    <expr_stmt><expr><name>csrattrs</name> <operator>=</operator> <name>csrattrs_data_pop</name></expr>;</expr_stmt>
	    <expr_stmt><expr><name>csrattrs_len</name> <operator>=</operator> <name>csrattrs_pop_len</name></expr>;</expr_stmt>
	}</block></then></if>
    }</block></then> <else>else <block>{
        <expr_stmt><expr><name>rv</name> <operator>=</operator> <call><name>est_asn1_parse_attributes</name><argument_list>(<argument><expr><name>csrattrs</name></expr></argument>, <argument><expr><name>csrattrs_len</name></expr></argument>, <argument><expr><operator>&amp;</operator><name>pop_present</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if>if <condition>(<expr><name>rv</name> <operator>!=</operator> <name>EST_ERR_NONE</name></expr>)</condition><then> <block>{
	    <expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Corrupt CSR Attributes"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	    <return>return <expr><operator>(</operator><name>EST_ERR_INVALID_PARAMETERS</name><operator>)</operator></expr>;</return>
	}</block></then></if>
    }</block></else></if>    

    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs</name></name> <operator>=</operator> <call><name>malloc</name><argument_list>(<argument><expr><name>csrattrs_len</name> <operator>+</operator> <literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if <condition>(<expr><operator>!</operator><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs</name></name></expr>)</condition><then> <block>{
        <if>if <condition>(<expr><name>csrattrs_data_pop</name></expr>)</condition><then> <block>{
            <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>csrattrs_data_pop</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	}</block></then></if>
        <return>return <expr><operator>(</operator><name>EST_ERR_MALLOC</name><operator>)</operator></expr>;</return>
    }</block></then></if>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name> <operator>=</operator> <name>csrattrs_len</name></expr>;</expr_stmt>

    <expr_stmt><expr><call><name>strncpy_s</name><argument_list>(<argument><expr><operator>(</operator><name>char</name> <operator>*</operator><operator>)</operator><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs</name></name></expr></argument>, <argument><expr><name>csrattrs_len</name> <operator>+</operator> <literal type="number">1</literal></expr></argument>, <argument><expr><name>csrattrs</name></expr></argument>, <argument><expr><name>csrattrs_len</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs</name><index>[<expr><name>csrattrs_len</name></expr>]</index></name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
    <if>if <condition>(<expr><name>csrattrs_data_pop</name></expr>)</condition><then> <block>{
      <expr_stmt><expr><call><name>free</name><argument_list>(<argument><expr><name>csrattrs_data_pop</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    }</block></then></if>
    <expr_stmt><expr><call><name>EST_LOG_INFO</name><argument_list>(<argument><expr><literal type="string">"Attributes pointer is %p, len=%d"</literal></expr></argument>, <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs</name></name></expr></argument>, 
		 <argument><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_csrattrs_len</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*! @brief est_server_enable_tls10() is a deprecated function. TLS 1.0
    is a violation of RFC7030 and it is no longer supported by the EST library.
    This function will log an error message and return EST_ERR_BAD_MODE.
    
    @param ctx Pointer to the EST context

    This function must be called prior to starting the EST server.  
 
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_enable_tls10</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>)</parameter_list>
<block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"TLS 1.0 is a violation of RFC7030 and therefore not supported"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_BAD_MODE</name><operator>)</operator></expr>;</return>

}</block></function>

<comment type="block">/*! @brief est_server_enforce_csrattrs() is used by an application to 
    enable checking of the CSR attributes on the EST server.  When
    enabled, the EST client must provide all the CSR attributes that
    were in the /csrattrs response sent by the server.  The enrollment
    will fail if the client fails to provide all the CSR attributes.
    This setting applies to simple enroll and reenroll operations.
    This setting applies only to server mode and has no bearing on
    proxy mode operation.
    
    @param ctx Pointer to the EST context

    This function must be called prior to starting the EST server.  
 
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_enforce_csrattr</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>)</parameter_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>enforce_csrattrs</name></name> <operator>=</operator> <literal type="number">1</literal></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>

<comment type="block">/*! @brief est_server_set_read_timeout() is used by an application to set
    timeout value of server read operations.  Once a socket is opened the
    EST server begins attempting to read from this socket.  This
    timeout value limits the amount of time the client will wait for the
    response.  The default value is set to EST_SSL_READ_TIMEOUT_DEF.

    @param ctx Pointer to the EST context
    @param timeout Integer value representing the read timeout in seconds.
    The minimum value is EST_SSL_READ_TIMEOUT_MIN and the maximum value is
    EST_SSL_READ_TIMEOUT_MAX.
 
    @return EST_ERROR.
 */</comment>
<function><type><name>EST_ERROR</name></type> <name>est_server_set_read_timeout</name> <parameter_list>(<parameter><decl><type><name>EST_CTX</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>timeout</name></decl></parameter>)</parameter_list>
<block>{
    <if>if <condition>(<expr><operator>!</operator><name>ctx</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Null context"</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_NO_CTX</name><operator>)</operator></expr>;</return>
    }</block></then></if>

    <if>if <condition>(<expr><name>timeout</name> <operator>&lt;</operator> <name>EST_SSL_READ_TIMEOUT_MIN</name> <operator>||</operator>
        <name>timeout</name> <operator>&gt;</operator> <name>EST_SSL_READ_TIMEOUT_MAX</name></expr>)</condition><then> <block>{
	<expr_stmt><expr><call><name>EST_LOG_ERR</name><argument_list>(<argument><expr><literal type="string">"Invalid read timeout value passed: %d "</literal></expr></argument>, <argument><expr><name>timeout</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <return>return <expr><operator>(</operator><name>EST_ERR_INVALID_PARAMETERS</name><operator>)</operator></expr>;</return>
    }</block></then></if>
        
    <expr_stmt><expr><name><name>ctx</name><operator>-&gt;</operator><name>server_read_timeout</name></name> <operator>=</operator> <name>timeout</name></expr>;</expr_stmt>
    <return>return <expr><operator>(</operator><name>EST_ERR_NONE</name><operator>)</operator></expr>;</return>
}</block></function>
</unit>
